# Python è£…é¥°å™¨å®Œå…¨æŒ‡å—

> ä»åŸºç¡€åˆ°å®æˆ˜ï¼Œå…¨é¢æŒæ¡ Python è£…é¥°å™¨

---

## ğŸ“‹ ç›®å½•

- [1. è£…é¥°å™¨åŸºç¡€](#1-è£…é¥°å™¨åŸºç¡€)
- [2. è£…é¥°å™¨å·¥ä½œåŸç†](#2-è£…é¥°å™¨å·¥ä½œåŸç†)
- [3. ä¿ç•™åŸå‡½æ•°ä¿¡æ¯](#3-ä¿ç•™åŸå‡½æ•°ä¿¡æ¯)
- [4. å¤„ç†å‚æ•°](#4-å¤„ç†å‚æ•°)
- [5. å¸¦å‚æ•°çš„è£…é¥°å™¨](#5-å¸¦å‚æ•°çš„è£…é¥°å™¨)
- [6. å¤šä¸ªè£…é¥°å™¨](#6-å¤šä¸ªè£…é¥°å™¨)
- [7. è£…é¥°å™¨ç±»](#7-è£…é¥°å™¨ç±»)
- [8. å¼‚æ­¥è£…é¥°å™¨](#8-å¼‚æ­¥è£…é¥°å™¨)
- [9. AgentScope ä¸­çš„åº”ç”¨](#9-agentscope-ä¸­çš„åº”ç”¨)
- [10. å¸¸è§è£…é¥°å™¨æ¨¡å¼](#10-å¸¸è§è£…é¥°å™¨æ¨¡å¼)
- [11. ç»ƒä¹ é¢˜åŠç­”æ¡ˆ](#11-ç»ƒä¹ é¢˜åŠç­”æ¡ˆ)
- [12. æœ€ä½³å®è·µ](#12-æœ€ä½³å®è·µ)

---

## 1. è£…é¥°å™¨åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯è£…é¥°å™¨ï¼Ÿ

**è£…é¥°å™¨ï¼ˆDecoratorï¼‰**æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¯ä»¥**åœ¨ä¸ä¿®æ”¹åŸå‡½æ•°ä»£ç **çš„æƒ…å†µä¸‹ï¼Œä¸ºå‡½æ•°**æ·»åŠ é¢å¤–åŠŸèƒ½**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è£…é¥°å™¨çš„æœ¬è´¨                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  è£…é¥°å™¨ = æ¥æ”¶å‡½æ•° â†’ åŒ…è£…å‡½æ•° â†’ è¿”å›æ–°å‡½æ•°             â”‚
â”‚                                                     â”‚
â”‚  åŸå‡½æ•°ä¿æŒä¸å˜ï¼Œä½†è°ƒç”¨æ—¶ä¼šæ‰§è¡Œé¢å¤–çš„ä»£ç               â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è£…é¥°å™¨ï¼Ÿ

**é—®é¢˜åœºæ™¯ï¼š**

```python
# ========== åœºæ™¯ï¼šä¸ºå¤šä¸ªå‡½æ•°æ·»åŠ æ—¥å¿— ==========

def func_a():
    print("æ‰§è¡Œ func_a")
    # æƒ³è¦æ·»åŠ è°ƒç”¨æ—¥å¿—ï¼Ÿ

def func_b():
    print("æ‰§è¡Œ func_b")
    # æƒ³è¦æ·»åŠ è°ƒç”¨æ—¥å¿—ï¼Ÿ

def func_c():
    print("æ‰§è¡Œ func_c")
    # æƒ³è¦æ·»åŠ è°ƒç”¨æ—¥å¿—ï¼Ÿ
```

**âŒ ä¸å¥½çš„åšæ³•ï¼šä¿®æ”¹æ¯ä¸ªå‡½æ•°**

```python
def func_a():
    print("[è°ƒç”¨] func_a")
    print("æ‰§è¡Œ func_a")
    print("[å®Œæˆ] func_a")

def func_b():
    print("[è°ƒç”¨] func_b")
    print("æ‰§è¡Œ func_b")
    print("[å®Œæˆ] func_b")

# é—®é¢˜ï¼š
# 1. é‡å¤ä»£ç å¤ªå¤š
# 2. ä¿®æ”¹å›°éš¾
# 3. æ±¡æŸ“åŸæœ‰é€»è¾‘
```

**âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨è£…é¥°å™¨**

```python
def log_decorator(func):
    """æ—¥å¿—è£…é¥°å™¨"""
    def wrapper():
        print(f"[è°ƒç”¨] {func.__name__}")
        result = func()
        print(f"[å®Œæˆ] {func.__name__}")
        return result
    return wrapper

@log_decorator
def func_a():
    print("æ‰§è¡Œ func_a")

@log_decorator
def func_b():
    print("æ‰§è¡Œ func_b")

# ä¼˜ç‚¹ï¼š
# 1. åŸå‡½æ•°ä»£ç ä¸å˜
# 2. æ—¥å¿—é€»è¾‘ç»Ÿä¸€ç®¡ç†
# 3. æ·»åŠ /åˆ é™¤åŠŸèƒ½å®¹æ˜“
```

### 1.3 è£…é¥°å™¨è¯­æ³•

```python
# ========== æ–¹æ³• 1ï¼šä½¿ç”¨ @ è¯­æ³•ï¼ˆæ¨èï¼‰==========
@decorator
def my_function():
    pass

# ========== æ–¹æ³• 2ï¼šæ‰‹åŠ¨è°ƒç”¨ï¼ˆç­‰ä»·ï¼‰==========
def my_function():
    pass

my_function = decorator(my_function)
```

### 1.4 ç¬¬ä¸€ä¸ªè£…é¥°å™¨ç¤ºä¾‹

```python
def simple_decorator(func):
    """ç®€å•çš„è£…é¥°å™¨"""
    print(f"è£…é¥°å™¨æ¥æ”¶å‡½æ•°: {func.__name__}")

    def wrapper():
        print("ğŸ“ è°ƒç”¨å‰")
        result = func()
        print("ğŸ“ è°ƒç”¨å")
        return result

    print("è£…é¥°å™¨è¿”å› wrapper å‡½æ•°")
    return wrapper

# ä½¿ç”¨è£…é¥°å™¨
@simple_decorator
def greet():
    print("Hello!")

print("\n=== è°ƒç”¨ greet ===")
greet()
```

**è¾“å‡ºï¼š**
```
è£…é¥°å™¨æ¥æ”¶å‡½æ•°: greet
è£…é¥°å™¨è¿”å› wrapper å‡½æ•°

=== è°ƒç”¨ greet ===
ğŸ“ è°ƒç”¨å‰
Hello!
ğŸ“ è°ƒç”¨å
```

---

## 2. è£…é¥°å™¨å·¥ä½œåŸç†

### 2.1 æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è£…é¥°å™¨çš„æ‰§è¡Œæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  å®šä¹‰é˜¶æ®µï¼ˆç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰                            â”‚
â”‚                                                          â”‚
â”‚  @decorator                                              â”‚
â”‚  def my_func():                                          â”‚
â”‚      pass                                                â”‚
â”‚                                                          â”‚
â”‚      â†“                                                   â”‚
â”‚                                                          â”‚
â”‚  1. å®šä¹‰ my_func å‡½æ•°                                     â”‚
â”‚  2. è°ƒç”¨ decorator(my_func)                              â”‚
â”‚  3. decorator è¿”å› wrapper                               â”‚
â”‚  4. my_func = wrapper                                    â”‚
â”‚                                                          â”‚
â”‚  è°ƒç”¨é˜¶æ®µï¼ˆæ¯æ¬¡è°ƒç”¨å‡½æ•°æ—¶æ‰§è¡Œï¼‰                            â”‚
â”‚                                                          â”‚
â”‚  my_func()                                               â”‚
â”‚      â†“                                                   â”‚
â”‚  å®é™…è°ƒç”¨ wrapper()                                      â”‚
â”‚      â†“                                                   â”‚
â”‚  wrapper å†…éƒ¨è°ƒç”¨åŸå§‹ func()                              â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¯¦ç»†ç¤ºä¾‹

```python
def detailed_decorator(func):
    """è¯¦ç»†å±•ç¤ºè£…é¥°å™¨æ‰§è¡Œè¿‡ç¨‹"""
    print(f"  [å®šä¹‰é˜¶æ®µ] è£…é¥°å™¨è¢«è°ƒç”¨")
    print(f"  [å®šä¹‰é˜¶æ®µ] æ¥æ”¶å‡½æ•°: {func.__name__}")

    def wrapper(*args, **kwargs):
        print(f"  [è°ƒç”¨é˜¶æ®µ] wrapper å¼€å§‹æ‰§è¡Œ")
        print(f"  [è°ƒç”¨é˜¶æ®µ] å‚æ•°: args={args}, kwargs={kwargs}")

        result = func(*args, **kwargs)

        print(f"  [è°ƒç”¨é˜¶æ®µ] åŸå‡½æ•°è¿”å›: {result}")
        print(f"  [è°ƒç”¨é˜¶æ®µ] wrapper ç»“æŸ")
        return result

    print(f"  [å®šä¹‰é˜¶æ®µ] è¿”å› wrapper å‡½æ•°")
    return wrapper

print("=== å¼€å§‹å®šä¹‰å‡½æ•° ===")
@detailed_decorator
def add(a, b):
    print(f"  [åŸå‡½æ•°] è®¡ç®— {a} + {b}")
    return a + b

print("\n=== ç¬¬ä¸€æ¬¡è°ƒç”¨ ===")
result1 = add(2, 3)
print(f"æœ€ç»ˆç»“æœ: {result1}")

print("\n=== ç¬¬äºŒæ¬¡è°ƒç”¨ ===")
result2 = add(5, 7)
print(f"æœ€ç»ˆç»“æœ: {result2}")
```

**è¾“å‡ºï¼š**
```
=== å¼€å§‹å®šä¹‰å‡½æ•° ===
  [å®šä¹‰é˜¶æ®µ] è£…é¥°å™¨è¢«è°ƒç”¨
  [å®šä¹‰é˜¶æ®µ] æ¥æ”¶å‡½æ•°: add
  [å®šä¹‰é˜¶æ®µ] è¿”å› wrapper å‡½æ•°

=== ç¬¬ä¸€æ¬¡è°ƒç”¨ ===
  [è°ƒç”¨é˜¶æ®µ] wrapper å¼€å§‹æ‰§è¡Œ
  [è°ƒç”¨é˜¶æ®µ] å‚æ•°: args=(2, 3), kwargs={}
  [åŸå‡½æ•°] è®¡ç®— 2 + 3
  [è°ƒç”¨é˜¶æ®µ] åŸå‡½æ•°è¿”å›: 5
  [è°ƒç”¨é˜¶æ®µ] wrapper ç»“æŸ
æœ€ç»ˆç»“æœ: 5

=== ç¬¬äºŒæ¬¡è°ƒç”¨ ===
  [è°ƒç”¨é˜¶æ®µ] wrapper å¼€å§‹æ‰§è¡Œ
  [è°ƒç”¨é˜¶æ®µ] å‚æ•°: args=(5, 7), kwargs={}
  [åŸå‡½æ•°] è®¡ç®— 5 + 7
  [è°ƒç”¨é˜¶æ®µ] åŸå‡½æ•°è¿”å›: 12
  [è°ƒç”¨é˜¶æ®µ] wrapper ç»“æŸ
æœ€ç»ˆç»“æœ: 12
```

### 2.3 è£…é¥°å™¨ç­‰ä»·å†™æ³•

```python
# ========== å†™æ³• 1ï¼šä½¿ç”¨ @ è¯­æ³• ==========
@my_decorator
def greet():
    return "Hello"

# ========== å†™æ³• 2ï¼šæ‰‹åŠ¨èµ‹å€¼ï¼ˆå®Œå…¨ç­‰ä»·ï¼‰==========
def greet():
    return "Hello"

greet = my_decorator(greet)

# ========== å†™æ³• 3ï¼šé€æ­¥å±•å¼€ ==========
def greet_original():
    return "Hello"

greet_with_decorator = my_decorator(greet_original)
greet = greet_with_decorator
```

### 2.4 è£…é¥°å™¨ä¸æ”¹å˜å‡½æ•°å¼•ç”¨

```python
def decorator(func):
    def wrapper():
        return func()
    return wrapper

@decorator
def func():
    return "result"

print(func)          # <function decorator.<locals>.wrapper at ...>
print(func.__name__) # wrapper (ä¸æ˜¯ func!)
```

---

## 3. ä¿ç•™åŸå‡½æ•°ä¿¡æ¯

### 3.1 é—®é¢˜ï¼šä¸¢å¤±å…ƒæ•°æ®

```python
def my_decorator(func):
    def wrapper():
        return func()
    return wrapper

@my_decorator
def greet():
    """å‘ç”¨æˆ·æ‰“æ‹›å‘¼"""
    return "Hello!"

# é—®é¢˜ï¼šå…ƒæ•°æ®ä¸¢å¤±
print(f"å‡½æ•°å: {greet.__name__}")   # wrapper (é”™è¯¯!)
print(f"æ–‡æ¡£: {greet.__doc__}")     # None (é”™è¯¯!)
print(f"æ¨¡å—: {greet.__module__}")  # __main__ (å¯èƒ½æ­£ç¡®)
```

### 3.2 è§£å†³æ–¹æ¡ˆï¼šfunctools.wraps

```python
from functools import wraps

def my_decorator(func):
    @wraps(func)  # ä¿ç•™åŸå‡½æ•°çš„å…ƒæ•°æ®
    def wrapper():
        return func()
    return wrapper

@my_decorator
def greet():
    """å‘ç”¨æˆ·æ‰“æ‹›å‘¼"""
    return "Hello!"

# ç°åœ¨ï¼šå…ƒæ•°æ®æ­£ç¡®
print(f"å‡½æ•°å: {greet.__name__}")   # greet âœ…
print(f"æ–‡æ¡£: {greet.__doc__}")     # å‘ç”¨æˆ·æ‰“æ‹›å‘¼ âœ…
print(f"æ¨¡å—: {greet.__module__}")  # __main__ âœ…
```

### 3.3 functools.wraps çš„ä½œç”¨

```python
from functools import wraps

def show_wraps_effect(func):
    """å±•ç¤º wraps çš„æ•ˆæœ"""
    def wrapper_without_wraps():
        return func()

    @wraps(func)
    def wrapper_with_wraps():
        return func()

    print("=== æ²¡æœ‰ @wraps ===")
    print(f"  __name__: {wrapper_without_wraps.__name__}")
    print(f"  __doc__: {wrapper_without_wraps.__doc__}")

    print("\n=== ä½¿ç”¨ @wraps ===")
    print(f"  __name__: {wrapper_with_wraps.__name__}")
    print(f"  __doc__: {wrapper_with_wraps.__doc__}")

@show_wraps_effect
def example_func():
    """è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å‡½æ•°"""
    pass

# è¾“å‡ºï¼š
# === æ²¡æœ‰ @wraps ===
#   __name__: wrapper_without_wraps
#   __doc__: None
#
# === ä½¿ç”¨ @wraps ===
#   __name__: example_func
#   __doc__: è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å‡½æ•°
```

### 3.4 @wraps å¤åˆ¶çš„å±æ€§

```python
from functools import wraps

@wraps(func, assigned=('__name__', '__doc__'), updated=())
def wrapper():
    return func()
```

**é»˜è®¤å¤åˆ¶çš„å±æ€§ï¼ˆassignedï¼‰ï¼š**
- `__module__`
- `__name__`
- `__qualname__`
- `__annotations__`
- `__doc__`

**é»˜è®¤æ›´æ–°çš„å±æ€§ï¼ˆupdatedï¼‰ï¼š**
- `__dict__`

---

## 4. å¤„ç†å‚æ•°

### 4.1 ä»»æ„ä½ç½®å‚æ•°å’Œå…³é”®å­—å‚æ•°

```python
from functools import wraps

def log_arguments(func):
    """è®°å½•å‡½æ•°è°ƒç”¨å‚æ•°"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        print(f"è°ƒç”¨ {func.__name__}:")
        print(f"  ä½ç½®å‚æ•°: {args}")
        print(f"  å…³é”®å­—å‚æ•°: {kwargs}")
        result = func(*args, **kwargs)
        print(f"  è¿”å›å€¼: {result}")
        return result
    return wrapper

@log_arguments
def add(a, b):
    return a + b

@log_arguments
def greet(name, greeting="Hello"):
    return f"{greeting}, {name}!"

# æµ‹è¯•
print("=== æµ‹è¯• 1 ===")
result1 = add(2, 3)

print("\n=== æµ‹è¯• 2 ===")
result2 = greet("Alice")

print("\n=== æµ‹è¯• 3 ===")
result3 = greet("Bob", greeting="Hi")
```

**è¾“å‡ºï¼š**
```
=== æµ‹è¯• 1 ===
è°ƒç”¨ add:
  ä½ç½®å‚æ•°: (2, 3)
  å…³é”®å­—å‚æ•°: {}
  è¿”å›å€¼: 5

=== æµ‹è¯• 2 ===
è°ƒç”¨ greet:
  ä½ç½®å‚æ•°: ('Alice',)
  å…³é”®å­—å‚æ•°: {}
  è¿”å›å€¼: Hello, Alice!

=== æµ‹è¯• 3 ===
è°ƒç”¨ greet:
  ä½ç½®å‚æ•°: ('Bob',)
  å…³é”®å­—å‚æ•°: {'greeting': 'Hi'}
  è¿”å›å€¼: Hi, Bob!
```

### 4.2 ä¿ç•™å‚æ•°é»˜è®¤å€¼

```python
from functools import wraps

def preserve_defaults(func):
    """ä¿ç•™åŸå‡½æ•°çš„å‚æ•°é»˜è®¤å€¼"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        return func(*args, **kwargs)
    return wrapper

@preserve_defaults
def example(a, b=10, c="default"):
    return f"a={a}, b={b}, c={c}"

print(example(1))            # a=1, b=10, c=default
print(example(1, 2))         # a=1, b=2, c=default
print(example(1, 2, "custom"))  # a=1, b=2, c=custom
```

### 4.3 å¤„ç†å¯å˜å‚æ•°

```python
from functools import wraps

def validate_args(func):
    """éªŒè¯å‚æ•°ç±»å‹"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        # è¿™é‡Œå¯ä»¥æ·»åŠ å‚æ•°éªŒè¯é€»è¾‘
        for arg in args:
            if not isinstance(arg, (int, float)):
                raise TypeError(f"å‚æ•°å¿…é¡»æ˜¯æ•°å­—ï¼Œæ”¶åˆ°: {type(arg)}")
        return func(*args, **kwargs)
    return wrapper

@validate_args
def calculate(x, y):
    return x + y

print(calculate(10, 20))      # 30
print(calculate(1.5, 2.5))    # 4.0
# print(calculate(10, "20"))  # TypeError
```

---

## 5. å¸¦å‚æ•°çš„è£…é¥°å™¨

### 5.1 åŸºæœ¬è¯­æ³•

```python
# å¸¦å‚æ•°çš„è£…é¥°å™¨ = è¿”å›è£…é¥°å™¨çš„å‡½æ•°

def repeat(times):
    """é‡å¤æ‰§è¡Œå‡½æ•° times æ¬¡"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            results = []
            for _ in range(times):
                result = func(*args, **kwargs)
                results.append(result)
            return results
        return wrapper
    return decorator

@repeat(3)
def say_hello():
    return "Hello!"

# ä½¿ç”¨
result = say_hello()
print(result)  # ['Hello!', 'Hello!', 'Hello!']
```

### 5.2 å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å¸¦å‚æ•°è£…é¥°å™¨çš„æ‰§è¡Œæµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  @repeat(3)                                              â”‚
â”‚  def say_hello():                                        â”‚
â”‚      return "Hello!"                                     â”‚
â”‚                                                          â”‚
â”‚      â†“                                                   â”‚
â”‚                                                          â”‚
â”‚  æ­¥éª¤ 1: repeat(3) è¢«è°ƒç”¨                                â”‚
â”‚          â†“                                               â”‚
â”‚      è¿”å› decorator å‡½æ•°                                 â”‚
â”‚          â†“                                               â”‚
â”‚  æ­¥éª¤ 2: decorator(say_hello) è¢«è°ƒç”¨                     â”‚
â”‚          â†“                                               â”‚
â”‚      è¿”å› wrapper å‡½æ•°                                   â”‚
â”‚          â†“                                               â”‚
â”‚  æ­¥éª¤ 3: say_hello = wrapper                            â”‚
â”‚                                                          â”‚
â”‚  ç­‰ä»·äºï¼š                                                 â”‚
â”‚  say_hello = repeat(3)(say_hello)                       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 æ‰‹åŠ¨å±•å¼€

```python
def repeat(times):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            results = []
            for _ in range(times):
                result = func(*args, **kwargs)
                results.append(result)
            return results
        return wrapper
    return decorator

# ========== ä½¿ç”¨ @ è¯­æ³• ==========
@repeat(3)
def say_hello():
    return "Hello!"

# ========== æ‰‹åŠ¨å±•å¼€ï¼ˆå®Œå…¨ç­‰ä»·ï¼‰==========
def say_hello_original():
    return "Hello!"

# æ­¥éª¤ 1: è·å–è£…é¥°å™¨
decorator = repeat(3)

# æ­¥éª¤ 2: åº”ç”¨è£…é¥°å™¨
say_hello = decorator(say_hello_original)
```

### 5.4 å¸¦å¤šä¸ªå‚æ•°çš„è£…é¥°å™¨

```python
def repeat_with_delay(times, delay):
    """é‡å¤æ‰§è¡Œï¼Œæ¯æ¬¡ä¹‹é—´æœ‰å»¶è¿Ÿ"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            results = []
            import time
            for i in range(times):
                result = func(*args, **kwargs)
                results.append(result)
                if i < times - 1:
                    time.sleep(delay)
            return results
        return wrapper
    return decorator

@repeat_with_delay(times=3, delay=1)
def get_timestamp():
    import time
    return time.time()

# ä½¿ç”¨
timestamps = get_timestamp()
for ts in timestamps:
    print(ts)
```

### 5.5 å¸¦å¯é€‰å‚æ•°çš„è£…é¥°å™¨

```python
from functools import wraps

def smart_decorator(arg=None):
    """æ™ºèƒ½è£…é¥°å™¨ï¼šå¯ä»¥å¸¦å‚æ•°æˆ–ä¸å¸¦å‚æ•°"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            print(f"è£…é¥°å™¨å‚æ•°: {arg}")
            return func(*args, **kwargs)
        return wrapper

    # å¦‚æœ arg æ˜¯å¯è°ƒç”¨å¯¹è±¡ï¼Œè¯´æ˜æ²¡æœ‰å‚æ•°
    if callable(arg):
        func = arg
        arg = None
        return decorator(func)
    else:
        return decorator

# ä¸å¸¦å‚æ•°
@smart_decorator
def func1():
    return "func1"

# å¸¦å‚æ•°
@smart_decorator(arg="custom")
def func2():
    return "func2"

func1()  # è£…é¥°å™¨å‚æ•°: None
func2()  # è£…é¥°å™¨å‚æ•°: custom
```

---

## 6. å¤šä¸ªè£…é¥°å™¨

### 6.1 åŸºæœ¬è¯­æ³•

```python
@decorator_a
@decorator_b
def my_function():
    pass

# ç­‰ä»·äºï¼š
# my_function = decorator_a(decorator_b(my_function))
```

### 6.2 æ‰§è¡Œé¡ºåº

```python
from functools import wraps

def decorator_a(func):
    @wraps(func)
    def wrapper():
        print("A: è°ƒç”¨å‰")
        result = func()
        print("A: è°ƒç”¨å")
        return result
    return wrapper

def decorator_b(func):
    @wraps(func)
    def wrapper():
        print("B: è°ƒç”¨å‰")
        result = func()
        print("B: è°ƒç”¨å")
        return result
    return wrapper

@decorator_a
@decorator_b
def my_func():
    print("åŸå‡½æ•°")

my_func()
```

**è¾“å‡ºï¼š**
```
A: è°ƒç”¨å‰
B: è°ƒç”¨å‰
åŸå‡½æ•°
B: è°ƒç”¨å
A: è°ƒç”¨å
```

### 6.3 å¯è§†åŒ–æ‰§è¡Œæµç¨‹

```
å®šä¹‰é¡ºåºï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰ï¼š
    my_func
         â†“
    åº”ç”¨ decorator_b
         â†“
    åº”ç”¨ decorator_a
         â†“
    æœ€ç»ˆå‡½æ•°

è°ƒç”¨é¡ºåºï¼ˆä»å¤–åˆ°å†…ï¼‰ï¼š
    decorator_a.wrapper å¼€å§‹
         â†“
    decorator_b.wrapper å¼€å§‹
         â†“
    my_func æ‰§è¡Œ
         â†“
    decorator_b.wrapper ç»“æŸ
         â†“
    decorator_a.wrapper ç»“æŸ
```

### 6.4 å®é™…åº”ç”¨ç¤ºä¾‹

```python
from functools import wraps
import time

def timer(func):
    """è®¡æ—¶è£…é¥°å™¨"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        end = time.time()
        print(f"â±ï¸  {func.__name__} è€—æ—¶: {end - start:.4f} ç§’")
        return result
    return wrapper

def logger(func):
    """æ—¥å¿—è£…é¥°å™¨"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        print(f"ğŸ“ è°ƒç”¨ {func.__name__}{args}")
        result = func(*args, **kwargs)
        print(f"ğŸ“ {func.__name__} è¿”å›: {result}")
        return result
    return wrapper

@timer
@logger
def calculate(x, y):
    time.sleep(0.1)
    return x + y

result = calculate(10, 20)
```

**è¾“å‡ºï¼š**
```
ğŸ“ è°ƒç”¨ calculate(10, 20)
ğŸ“ calculate è¿”å›: 30
â±ï¸  calculate è€—æ—¶: 0.1001 ç§’
```

---

## 7. è£…é¥°å™¨ç±»

### 7.1 ä½¿ç”¨ç±»ä½œä¸ºè£…é¥°å™¨

```python
class DecoratorClass:
    """è£…é¥°å™¨ç±»"""

    def __init__(self, func):
        self.func = func

    def __call__(self, *args, **kwargs):
        print(f"è°ƒç”¨ {self.func.__name__}")
        result = self.func(*args, **kwargs)
        return result

@DecoratorClass
def greet():
    return "Hello!"

greet()  # è°ƒç”¨ greet
```

### 7.2 å¸¦å‚æ•°çš„è£…é¥°å™¨ç±»

```python
class RepeatDecorator:
    """å¸¦å‚æ•°çš„è£…é¥°å™¨ç±»"""

    def __init__(self, times):
        self.times = times

    def __call__(self, func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            results = []
            for _ in range(self.times):
                result = func(*args, **kwargs)
                results.append(result)
            return results
        return wrapper

@RepeatDecorator(times=3)
def say_hello():
    return "Hello!"

print(say_hello())  # ['Hello!', 'Hello!', 'Hello!']
```

### 7.3 è£…é¥°å™¨ç±» vs è£…é¥°å™¨å‡½æ•°

```python
# ========== è£…é¥°å™¨å‡½æ•° ==========
def function_decorator(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        return func(*args, **kwargs)
    return wrapper

# ========== è£…é¥°å™¨ç±»ï¼ˆç­‰ä»·ï¼‰==========
class ClassDecorator:
    def __init__(self, func):
        self.func = func
        wraps(func)(self)  # å¤åˆ¶å…ƒæ•°æ®

    def __call__(self, *args, **kwargs):
        return self.func(*args, **kwargs)

# ä½¿ç”¨
@function_decorator
def func1():
    pass

@ClassDecorator
def func2():
    pass
```

---

## 8. å¼‚æ­¥è£…é¥°å™¨

### 8.1 åŸºç¡€å¼‚æ­¥è£…é¥°å™¨

```python
from functools import wraps
import asyncio

def async_timer(func):
    """æµ‹é‡å¼‚æ­¥å‡½æ•°æ‰§è¡Œæ—¶é—´"""
    @wraps(func)
    async def wrapper(*args, **kwargs):
        import time
        start = time.time()
        result = await func(*args, **kwargs)
        end = time.time()
        print(f"â±ï¸  {func.__name__} è€—æ—¶: {end - start:.2f} ç§’")
        return result
    return wrapper

@async_timer
async def slow_task():
    await asyncio.sleep(1)
    return "å®Œæˆ"

async def main():
    result = await slow_task()
    print(f"ç»“æœ: {result}")

asyncio.run(main())

# è¾“å‡ºï¼š
# â±ï¸  slow_task è€—æ—¶: 1.00 ç§’
# ç»“æœ: å®Œæˆ
```

### 8.2 åŒæ—¶æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥

```python
import asyncio
import inspect
from functools import wraps

def universal_timer(func):
    """åŒæ—¶æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å‡½æ•°çš„è®¡æ—¶è£…é¥°å™¨"""

    @wraps(func)
    async def async_wrapper(*args, **kwargs):
        import time
        start = time.time()
        result = await func(*args, **kwargs)
        end = time.time()
        print(f"â±ï¸  {func.__name__} è€—æ—¶: {end - start:.2f} ç§’")
        return result

    @wraps(func)
    def sync_wrapper(*args, **kwargs):
        import time
        start = time.time()
        result = func(*args, **kwargs)
        end = time.time()
        print(f"â±ï¸  {func.__name__} è€—æ—¶: {end - start:.2f} ç§’")
        return result

    # æ ¹æ®å‡½æ•°ç±»å‹è¿”å›ä¸åŒçš„ wrapper
    if inspect.iscoroutinefunction(func):
        return async_wrapper
    else:
        return sync_wrapper

# æµ‹è¯•
@universal_timer
def sync_func():
    import time
    time.sleep(1)
    return "åŒæ­¥å®Œæˆ"

@universal_timer
async def async_func():
    await asyncio.sleep(1)
    return "å¼‚æ­¥å®Œæˆ"

sync_func()
asyncio.run(async_func())
```

### 8.3 å¼‚æ­¥è£…é¥°å™¨å¸¦å‚æ•°

```python
from functools import wraps
import asyncio

def async_retry(max_attempts=3, delay=1):
    """å¼‚æ­¥é‡è¯•è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return await func(*args, **kwargs)
                except Exception as e:
                    if attempt == max_attempts - 1:
                        raise
                    print(f"ç¬¬ {attempt + 1} æ¬¡å¤±è´¥: {e}")
                    print(f"{delay} ç§’åé‡è¯•...")
                    await asyncio.sleep(delay)
        return wrapper
    return decorator

@async_retry(max_attempts=3, delay=0.5)
async def unreliable_async_task():
    import random
    if random.random() < 0.7:
        raise ConnectionError("è¿æ¥å¤±è´¥")
    return "æˆåŠŸ"

asyncio.run(unreliable_async_task())
```

---

## 9. AgentScope ä¸­çš„åº”ç”¨

### 9.1 AgentApp è£…é¥°å™¨

```python
from agentscope_runtime.engine import AgentApp
from agentscope_runtime.engine.schemas.agent_schemas import AgentRequest

agent_app = AgentApp(
    app_name="MyAgent",
    app_description="æˆ‘çš„ AI åŠ©æ‰‹"
)

# ========== @agent_app.init è£…é¥°å™¨ ==========
@agent_app.init
async def init_func(self):
    """æœåŠ¡å¯åŠ¨æ—¶è°ƒç”¨

    ç”¨äºåˆå§‹åŒ–æœåŠ¡ã€è¿æ¥æ•°æ®åº“ç­‰æ“ä½œ
    """
    self.state_service = InMemoryStateService()
    self.session_service = InMemorySessionHistoryService()

    await self.state_service.start()
    await self.session_service.start()

    print("âœ… æœåŠ¡åˆå§‹åŒ–å®Œæˆ")

# ========== @agent_app.shutdown è£…é¥°å™¨ ==========
@agent_app.shutdown
async def shutdown_func(self):
    """æœåŠ¡å…³é—­æ—¶è°ƒç”¨

    ç”¨äºæ¸…ç†èµ„æºã€å…³é—­è¿æ¥ç­‰æ“ä½œ
    """
    await self.state_service.stop()
    await self.session_service.stop()

    print("âœ… æœåŠ¡æ¸…ç†å®Œæˆ")

# ========== @agent_app.query è£…é¥°å™¨ ==========
@agent_app.query(framework="agentscope")
async def query_func(
    self,
    msgs,
    request: AgentRequest = None,
    **kwargs,
):
    """å¤„ç†æŸ¥è¯¢è¯·æ±‚

    Args:
        msgs: æ¶ˆæ¯åˆ—è¡¨
        request: è¯·æ±‚å¯¹è±¡
        **kwargs: å…¶ä»–å‚æ•°

    Yields:
        tuple: (message, is_last)
    """
    session_id = request.session_id
    user_id = request.user_id

    # è·å–æˆ–åˆ›å»º agent
    agent = self.get_or_create_agent(session_id, user_id)

    # æµå¼è¾“å‡ºå“åº”
    async for msg, last in stream_printing_messages(
        agents=[agent],
        coroutine_task=agent(msgs),
    ):
        yield msg, last

    # ä¿å­˜çŠ¶æ€
    state = agent.state_dict()
    await self.state_service.save_state(
        user_id=user_id,
        session_id=session_id,
        state=state,
    )
```

### 9.2 è£…é¥°å™¨çš„ä½œç”¨

```python
# è¿™äº›è£…é¥°å™¨å®é™…ä¸Šæ˜¯åœ¨æ³¨å†Œå‡½æ•°

@agent_app.init
async def init_func(self):
    pass

# å†…éƒ¨å®ç°ç±»ä¼¼äºï¼š
# agent_app.register_init(init_func)


@agent_app.query(framework="agentscope")
async def query_func(self, msgs, request=None, **kwargs):
    pass

# å†…éƒ¨å®ç°ç±»ä¼¼äºï¼š
# agent_app.register_query(query_func, framework="agentscope")


@agent_app.shutdown
async def shutdown_func(self):
    pass

# å†…éƒ¨å®ç°ç±»ä¼¼äºï¼š
# agent_app.register_shutdown(shutdown_func)
```

### 9.3 å®Œæ•´çš„ AgentScope è£…é¥°å™¨ç¤ºä¾‹

```python
from agentscope_runtime.engine import AgentApp
from agentscope.agent import ReActAgent
from agentscope.model import DashScopeChatModel
from agentscope.memory import InMemoryMemory
from agentscope.formatter import DashScopeChatFormatter
from agentscope.pipeline import stream_printing_messages
import os

# åˆ›å»º AgentApp
agent_app = AgentApp(
    app_name="MyAssistant",
    app_description="ä¸€ä¸ªæµå¼å“åº”çš„ AI åŠ©æ‰‹",
)

# åˆå§‹åŒ–è£…é¥°å™¨
@agent_app.init
async def init_func(self):
    """åˆå§‹åŒ–æœåŠ¡"""
    self.model = DashScopeChatModel(
        model_name="qwen-turbo",
        api_key=os.getenv("DASHSCOPE_API_KEY"),
        stream=True,
    )
    print("âœ… AgentApp åˆå§‹åŒ–å®Œæˆ")

# æŸ¥è¯¢è£…é¥°å™¨
@agent_app.query(framework="agentscope")
async def query_func(self, msgs, request=None, **kwargs):
    """å¤„ç†æŸ¥è¯¢"""

    # åˆ›å»º agent
    agent = ReActAgent(
        name="assistant",
        model=self.model,
        memory=InMemoryMemory(),
        formatter=DashScopeChatFormatter(),
    )

    # æµå¼è¾“å‡º
    async for msg, last in stream_printing_messages(
        agents=[agent],
        coroutine_task=agent(msgs),
    ):
        yield msg, last

# å…³é—­è£…é¥°å™¨
@agent_app.shutdown
async def shutdown_func(self):
    """æ¸…ç†èµ„æº"""
    print("âœ… AgentApp æ¸…ç†å®Œæˆ")

# è¿è¡ŒæœåŠ¡
if __name__ == "__main__":
    agent_app.run(host="0.0.0.0", port=8090)
```

---

## 10. å¸¸è§è£…é¥°å™¨æ¨¡å¼

### 10.1 è®¡æ—¶è£…é¥°å™¨

```python
import time
from functools import wraps

def timer(func):
    """æµ‹é‡å‡½æ•°æ‰§è¡Œæ—¶é—´"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.perf_counter()
        result = func(*args, **kwargs)
        end = time.perf_counter()
        elapsed = end - start
        print(f"{func.__name__} æ‰§è¡Œæ—¶é—´: {elapsed:.4f} ç§’")
        return result
    return wrapper

@timer
def slow_function():
    time.sleep(1)
    return "å®Œæˆ"

slow_function()
```

### 10.2 é‡è¯•è£…é¥°å™¨

```python
import time
from functools import wraps

def retry(max_attempts=3, delay=1, exceptions=(Exception,)):
    """å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return func(*args, **kwargs)
                except exceptions as e:
                    if attempt == max_attempts - 1:
                        print(f"âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° ({max_attempts})")
                        raise
                    print(f"âš ï¸  ç¬¬ {attempt + 1} æ¬¡å¤±è´¥: {e}")
                    print(f"ğŸ”„ {delay} ç§’åé‡è¯•...")
                    time.sleep(delay)
        return wrapper
    return decorator

@retry(max_attempts=3, delay=0.5)
def unreliable_function():
    import random
    if random.random() < 0.7:
        raise ConnectionError("è¿æ¥å¤±è´¥")
    return "æˆåŠŸ"

unreliable_function()
```

### 10.3 ç¼“å­˜è£…é¥°å™¨

```python
from functools import wraps, lru_cache

# ä½¿ç”¨å†…ç½® LRU ç¼“å­˜
@lru_cache(maxsize=128)
def expensive_function(n):
    """è®¡ç®—æ–æ³¢é‚£å¥‘æ•°ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    if n < 2:
        return n
    return expensive_function(n - 1) + expensive_function(n - 2)

# è‡ªå®šä¹‰ç¼“å­˜è£…é¥°å™¨
def memoize(func):
    """è‡ªå®šä¹‰ç¼“å­˜è£…é¥°å™¨"""
    cache = {}

    @wraps(func)
    def wrapper(*args, **kwargs):
        # åˆ›å»ºç¼“å­˜é”®
        key = (args, frozenset(kwargs.items()))
        if key not in cache:
            cache[key] = func(*args, **kwargs)
        return cache[key]

    return wrapper

@memoize
def fibonacci(n):
    if n < 2:
        return n
    return fibonacci(n - 1) + fibonacci(n - 2)
```

### 10.4 æƒé™æ£€æŸ¥è£…é¥°å™¨

```python
from functools import wraps

def require_role(role):
    """æ£€æŸ¥ç”¨æˆ·è§’è‰²"""
    def decorator(func):
        @wraps(func)
        def wrapper(user, *args, **kwargs):
            if user.get('role') != role:
                raise PermissionError(f"éœ€è¦ {role} æƒé™")
            return func(user, *args, **kwargs)
        return wrapper
    return decorator

@require_role('admin')
def delete_user(admin_user, user_id):
    return f"ç”¨æˆ· {user_id} å·²åˆ é™¤"

@require_role('user')
def view_profile(user, profile_id):
    return f"æŸ¥çœ‹èµ„æ–™ {profile_id}"

# æµ‹è¯•
admin = {'role': 'admin', 'name': 'Alice'}
guest = {'role': 'guest', 'name': 'Bob'}

print(delete_user(admin, 123))  # âœ… æˆåŠŸ
print(view_profile(admin, 456))  # âœ… æˆåŠŸ
# print(delete_user(guest, 123))  # âŒ PermissionError
```

### 10.5 ç±»å‹æ£€æŸ¥è£…é¥°å™¨

```python
from functools import wraps

def validate_types(**type_map):
    """éªŒè¯å‚æ•°ç±»å‹"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # è·å–å‡½æ•°ç­¾å
            import inspect
            sig = inspect.signature(func)
            bound_args = sig.bind(*args, **kwargs)
            bound_args.apply_defaults()

            # éªŒè¯ç±»å‹
            for param_name, param_value in bound_args.arguments.items():
                if param_name in type_map:
                    expected_type = type_map[param_name]
                    if not isinstance(param_value, expected_type):
                        raise TypeError(
                            f"{param_name} åº”ä¸º {expected_type}, "
                            f"æ”¶åˆ° {type(param_value)}"
                        )

            return func(*args, **kwargs)
        return wrapper
    return decorator

@validate_types(x=int, y=int, z=float)
def calculate(x, y, z=0.0):
    return x + y + z

print(calculate(10, 20))        # 30.0
print(calculate(10, 20, 1.5))   # 31.5
# print(calculate(10, "20"))    # TypeError
```

### 10.6 æ—¥å¿—è£…é¥°å™¨

```python
import logging
from functools import wraps

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def log(func):
    """è®°å½•å‡½æ•°è°ƒç”¨"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        logger.info(f"è°ƒç”¨ {func.__name__}")
        logger.info(f"  å‚æ•°: args={args}, kwargs={kwargs}")
        try:
            result = func(*args, **kwargs)
            logger.info(f"  è¿”å›: {result}")
            return result
        except Exception as e:
            logger.error(f"  å¼‚å¸¸: {e}")
            raise
    return wrapper

@log
def divide(a, b):
    return a / b

divide(10, 2)   # è®°å½•æ­£å¸¸è°ƒç”¨
# divide(10, 0)  # è®°å½•å¼‚å¸¸
```

### 10.7 é™æµè£…é¥°å™¨

```python
import time
from functools import wraps

def rate_limit(calls_per_second):
    """é™åˆ¶å‡½æ•°è°ƒç”¨é¢‘ç‡"""
    min_interval = 1.0 / calls_per_second

    def decorator(func):
        last_called = [0.0]  # ä½¿ç”¨åˆ—è¡¨é¿å… nonlocal

        @wraps(func)
        def wrapper(*args, **kwargs):
            elapsed = time.time() - last_called[0]
            left_to_wait = min_interval - elapsed

            if left_to_wait > 0:
                time.sleep(left_to_wait)

            result = func(*args, **kwargs)
            last_called[0] = time.time()
            return result

        return wrapper
    return decorator

@rate_limit(calls_per_second=2)
def api_call():
    print(f"API è°ƒç”¨: {time.time()}")

api_call()
api_call()
api_call()  # ä¼šç­‰å¾…
```

---

## 11. ç»ƒä¹ é¢˜åŠç­”æ¡ˆ

### ç»ƒä¹  1ï¼šåŸºç¡€è£…é¥°å™¨

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªè£…é¥°å™¨ï¼Œåœ¨å‡½æ•°è°ƒç”¨å‰åæ‰“å°æ˜Ÿå·ã€‚

```python
def star_decorator(func):
    # TODO: å®ç°è¿™ä¸ªè£…é¥°å™¨
    pass

@star_decorator
def hello():
    print("Hello!")

hello()
# æœŸæœ›è¾“å‡ºï¼š
# ***
# Hello!
# ***
```

**ç­”æ¡ˆï¼š**

```python
from functools import wraps

def star_decorator(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        print("***")
        result = func(*args, **kwargs)
        print("***")
        return result
    return wrapper
```

---

### ç»ƒä¹  2ï¼šè®¡æ—¶è£…é¥°å™¨

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªè®¡æ—¶è£…é¥°å™¨ï¼Œæµ‹é‡å‡½æ•°æ‰§è¡Œæ—¶é—´ã€‚

```python
def timer(func):
    # TODO: å®ç°è¿™ä¸ªè£…é¥°å™¨
    pass

@timer
def slow_function():
    import time
    time.sleep(1)
    return "å®Œæˆ"

slow_function()
# æœŸæœ›è¾“å‡ºç±»ä¼¼ï¼š
# slow_function æ‰§è¡Œæ—¶é—´: 1.0012 ç§’
```

**ç­”æ¡ˆï¼š**

```python
import time
from functools import wraps

def timer(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.perf_counter()
        result = func(*args, **kwargs)
        end = time.perf_counter()
        elapsed = end - start
        print(f"{func.__name__} æ‰§è¡Œæ—¶é—´: {elapsed:.4f} ç§’")
        return result
    return wrapper
```

---

### ç»ƒä¹  3ï¼šå¸¦å‚æ•°çš„è£…é¥°å™¨

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªè£…é¥°å™¨ï¼Œå°†å‡½æ•°ç»“æœé‡å¤ n æ¬¡ã€‚

```python
def repeat_result(n):
    # TODO: å®ç°è¿™ä¸ªè£…é¥°å™¨
    pass

@repeat_result(3)
def get_value():
    return "A"

print(get_value())
# æœŸæœ›è¾“å‡ºï¼š['A', 'A', 'A']
```

**ç­”æ¡ˆï¼š**

```python
from functools import wraps

def repeat_result(n):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            result = func(*args, **kwargs)
            return [result] * n
        return wrapper
    return decorator
```

---

### ç»ƒä¹  4ï¼šå¼‚æ­¥è£…é¥°å™¨

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªå¼‚æ­¥è®¡æ—¶è£…é¥°å™¨ã€‚

```python
def async_timer(func):
    # TODO: å®ç°è¿™ä¸ªè£…é¥°å™¨
    pass

@async_timer
async def slow_task():
    import asyncio
    await asyncio.sleep(1)
    return "å®Œæˆ"

import asyncio
asyncio.run(slow_task())
# æœŸæœ›è¾“å‡ºï¼š
# slow_task è€—æ—¶: 1.00 ç§’
```

**ç­”æ¡ˆï¼š**

```python
import time
from functools import wraps

def async_timer(func):
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start = time.perf_counter()
        result = await func(*args, **kwargs)
        end = time.perf_counter()
        elapsed = end - start
        print(f"{func.__name__} è€—æ—¶: {elapsed:.2f} ç§’")
        return result
    return wrapper
```

---

### ç»ƒä¹  5ï¼šé‡è¯•è£…é¥°å™¨

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªé‡è¯•è£…é¥°å™¨ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ã€‚

```python
def retry(max_attempts=3, delay=1):
    # TODO: å®ç°è¿™ä¸ªè£…é¥°å™¨
    pass

@retry(max_attempts=3, delay=0.5)
def unreliable_function():
    import random
    if random.random() < 0.7:
        raise ConnectionError("è¿æ¥å¤±è´¥")
    return "æˆåŠŸ"

unreliable_function()
```

**ç­”æ¡ˆï¼š**

```python
import time
from functools import wraps

def retry(max_attempts=3, delay=1):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    if attempt == max_attempts - 1:
                        print(f"âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°")
                        raise
                    print(f"âš ï¸  ç¬¬ {attempt + 1} æ¬¡å¤±è´¥: {e}")
                    print(f"ğŸ”„ {delay} ç§’åé‡è¯•...")
                    time.sleep(delay)
        return wrapper
    return decorator
```

---

### ç»ƒä¹  6ï¼šå¤šä¸ªè£…é¥°å™¨

**é¢˜ç›®ï¼š** å®ç°è®¡æ—¶å’Œæ—¥å¿—ä¸¤ä¸ªè£…é¥°å™¨ï¼Œå¹¶ç»„åˆä½¿ç”¨ã€‚

```python
def timer(func):
    # TODO: å®ç°è®¡æ—¶è£…é¥°å™¨
    pass

def logger(func):
    # TODO: å®ç°æ—¥å¿—è£…é¥°å™¨
    pass

@timer
@logger
def process_data(data):
    import time
    time.sleep(0.1)
    return data.upper()

result = process_data("hello")
# æœŸæœ›è¾“å‡ºï¼š
# ğŸ“ è°ƒç”¨ process_data
# ğŸ“ process_data è¿”å›: HELLO
# â±ï¸  process_data æ‰§è¡Œæ—¶é—´: 0.1001 ç§’
```

**ç­”æ¡ˆï¼š**

```python
import time
from functools import wraps

def timer(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.perf_counter()
        result = func(*args, **kwargs)
        end = time.perf_counter()
        print(f"â±ï¸  {func.__name__} æ‰§è¡Œæ—¶é—´: {end - start:.4f} ç§’")
        return result
    return wrapper

def logger(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        print(f"ğŸ“ è°ƒç”¨ {func.__name__}")
        result = func(*args, **kwargs)
        print(f"ğŸ“ {func.__name__} è¿”å›: {result}")
        return result
    return wrapper
```

---

### ç»ƒä¹  7ï¼šç¼“å­˜è£…é¥°å™¨

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªç®€å•çš„ç¼“å­˜è£…é¥°å™¨ã€‚

```python
def memoize(func):
    # TODO: å®ç°ç¼“å­˜è£…é¥°å™¨
    pass

@memoize
def fibonacci(n):
    if n < 2:
        return n
    return fibonacci(n - 1) + fibonacci(n - 2)

print(fibonacci(100))  # åº”è¯¥å¿«é€Ÿè®¡ç®—
```

**ç­”æ¡ˆï¼š**

```python
from functools import wraps

def memoize(func):
    cache = {}

    @wraps(func)
    def wrapper(*args, **kwargs):
        # åˆ›å»ºç¼“å­˜é”®
        key = (args, frozenset(kwargs.items()))
        if key not in cache:
            cache[key] = func(*args, **kwargs)
        return cache[key]

    # æ·»åŠ æ¸…é™¤ç¼“å­˜çš„æ–¹æ³•
    wrapper.cache_clear = cache.clear
    wrapper.cache_info = lambda: {'hits': len(cache), 'size': len(cache)}

    return wrapper
```

---

## 12. æœ€ä½³å®è·µ

### 12.1 å§‹ç»ˆä½¿ç”¨ functools.wraps

```python
# âœ… å¥½çš„åšæ³•
from functools import wraps

def my_decorator(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        return func(*args, **kwargs)
    return wrapper

# âŒ ä¸å¥½çš„åšæ³•
def my_decorator(func):
    def wrapper(*args, **kwargs):
        return func(*args, **kwargs)
    return wrapper  # ä¸¢å¤±åŸå‡½æ•°ä¿¡æ¯
```

### 12.2 è£…é¥°å™¨å‘½åè§„èŒƒ

```python
# âœ… å¥½çš„å‘½åï¼šæ¸…æ™°è¡¨æ˜æ˜¯è£…é¥°å™¨
def log_decorator(func):
    pass

def timer_decorator(func):
    pass

# âœ… ä¹Ÿå¯ä»¥ç”¨æè¿°æ€§åç§°
def logged(func):
    pass

def timed(func):
    pass

# âŒ ä¸å¥½çš„å‘½åï¼šæ„å›¾ä¸æ˜ç¡®
def wrapper(func):
    pass

def decorate(func):
    pass
```

### 12.3 æ–‡æ¡£å­—ç¬¦ä¸²

```python
from functools import wraps

def repeat(times):
    """é‡å¤æ‰§è¡Œå‡½æ•°è£…é¥°å™¨

    Args:
        times: é‡å¤æ¬¡æ•°

    Returns:
        è£…é¥°å™¨å‡½æ•°

    Example:
        @repeat(3)
        def say_hi():
            return "Hi"
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            results = []
            for _ in range(times):
                result = func(*args, **kwargs)
                results.append(result)
            return results
        return wrapper
    return decorator
```

### 12.4 é¿å…å¸¸è§é™·é˜±

```python
# ========== é™·é˜± 1ï¼šè£…é¥°å™¨åªæ‰§è¡Œä¸€æ¬¡ ==========
def decorator(func):
    print("è£…é¥°å™¨è¢«è°ƒç”¨")
    @wraps(func)
    def wrapper():
        return func()
    return wrapper

@decorator
def func():
    pass

# è¾“å‡ºï¼šè£…é¥°å™¨è¢«è°ƒç”¨ï¼ˆå®šä¹‰æ—¶ï¼‰
func()  # ä¸ä¼šå†æ¬¡æ‰“å°

# ========== é™·é˜± 2ï¼šè£…é¥°å™¨é¡ºåºå¾ˆé‡è¦ ==========
@decorator_a
@decorator_b
def func():
    pass

# ç­‰ä»·äºï¼šfunc = decorator_a(decorator_b(func))
# ä¸æ˜¯ï¼šfunc = decorator_b(decorator_a(func))


# ========== é™·é˜± 3ï¼šå¯å˜é»˜è®¤å‚æ•° ==========
def bad_decorator(func, cache={}):  # âŒ å±é™©ï¼
    @wraps(func)
    def wrapper(*args, **kwargs):
        # cache åœ¨æ‰€æœ‰è°ƒç”¨ä¹‹é—´å…±äº«
        pass
    return wrapper

# âœ… ä½¿ç”¨å‡½æ•°å±æ€§
def good_decorator(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        if not hasattr(wrapper, 'cache'):
            wrapper.cache = {}
        pass
    return wrapper
```

### 12.5 æ€§èƒ½è€ƒè™‘

```python
# âœ… è£…é¥°å™¨åº”è¯¥å°½é‡è½»é‡
from functools import wraps

def lightweight_decorator(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        # å¿«é€Ÿæ£€æŸ¥
        if not wrapper.enabled:
            return func(*args, **kwargs)

        # æ·»åŠ åŠŸèƒ½
        return func(*args, **kwargs)

    wrapper.enabled = True
    return wrapper

# âŒ é¿å…åœ¨è£…é¥°å™¨ä¸­è¿›è¡Œç¹é‡æ“ä½œ
def heavy_decorator(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        # é¿å…åœ¨è¿™é‡Œè¿›è¡Œå¤§é‡è®¡ç®—
        # æ¯æ¬¡è°ƒç”¨éƒ½ä¼šæ‰§è¡Œ
        pass
    return wrapper
```

### 12.6 è°ƒè¯•è£…é¥°å™¨

```python
from functools import wraps

def debug_decorator(func):
    """è°ƒè¯•è£…é¥°å™¨ï¼šæ‰“å°è°ƒç”¨ä¿¡æ¯"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        print(f"ğŸ” è°ƒç”¨ {func.__name__}")
        print(f"  å‚æ•°: args={args}, kwargs={kwargs}")

        try:
            result = func(*args, **kwargs)
            print(f"  è¿”å›: {result}")
            return result
        except Exception as e:
            print(f"  å¼‚å¸¸: {type(e).__name__}: {e}")
            raise

    return wrapper

# ä½¿ç”¨
@debug_decorator
def divide(a, b):
    return a / b

divide(10, 2)
# divide(10, 0)  # æŸ¥çœ‹å¼‚å¸¸ä¿¡æ¯
```

---

## âœ… å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹æ£€æŸ¥é¡¹ï¼Œç¡®è®¤ä½ å·²æŒæ¡è£…é¥°å™¨ï¼š

### åŸºç¡€ç†è§£
- [ ] ç†è§£è£…é¥°å™¨çš„åŸºæœ¬æ¦‚å¿µ
- [ ] ç†è§£ `@decorator` è¯­æ³•
- [ ] çŸ¥é“è£…é¥°å™¨çš„ç­‰ä»·å†™æ³•
- [ ] ç†è§£è£…é¥°å™¨çš„æ‰§è¡Œæ—¶æœº

### å®ç°èƒ½åŠ›
- [ ] èƒ½å¤Ÿå®ç°ç®€å•çš„è£…é¥°å™¨
- [ ] èƒ½å¤Ÿä½¿ç”¨ `functools.wraps`
- [ ] èƒ½å¤Ÿå¤„ç†ä»»æ„å‚æ•°
- [ ] èƒ½å¤Ÿå®ç°å¸¦å‚æ•°çš„è£…é¥°å™¨

### é«˜çº§ç‰¹æ€§
- [ ] ç†è§£å¤šä¸ªè£…é¥°å™¨çš„æ‰§è¡Œé¡ºåº
- [ ] èƒ½å¤Ÿä½¿ç”¨ç±»ä½œä¸ºè£…é¥°å™¨
- [ ] èƒ½å¤Ÿå®ç°å¼‚æ­¥è£…é¥°å™¨
- [ ] ç†è§£è£…é¥°å™¨ç±»çš„ `__call__` æ–¹æ³•

### AgentScope åº”ç”¨
- [ ] ç†è§£ `@agent_app.init` çš„ä½œç”¨
- [ ] ç†è§£ `@agent_app.query` çš„ä½œç”¨
- [ ] ç†è§£ `@agent_app.shutdown` çš„ä½œç”¨
- [ ] èƒ½å¤Ÿåœ¨ AgentScope ä¸­ä½¿ç”¨è£…é¥°å™¨

### æœ€ä½³å®è·µ
- [ ] å§‹ç»ˆä½¿ç”¨ `functools.wraps`
- [ ] éµå¾ªè£…é¥°å™¨å‘½åè§„èŒƒ
- [ ] ç¼–å†™æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²
- [ ] é¿å…å¸¸è§é™·é˜±

---

## ğŸ“š è®°å¿†å£è¯€

```
è£…é¥°å™¨æ ¸å¿ƒï¼š

@decorator        â†’ è¯­æ³•ç³–
def func():       â†’ åŸå‡½æ•°
    pass

ç­‰ä»·äºï¼š
func = decorator(func)

---

è£…é¥°å™¨æœ¬è´¨ï¼š

æ¥æ”¶å‡½æ•° â†’ åŒ…è£…å‡½æ•° â†’ è¿”å›æ–°å‡½æ•°

---

@wraps çš„ä½œç”¨ï¼š

ä¿ç•™åŸå‡½æ•°çš„ __name__ã€__doc__ ç­‰å…ƒæ•°æ®

---

è£…é¥°å™¨é¡ºåºï¼š

ä»ä¸‹åˆ°ä¸Šåº”ç”¨ï¼Œä»å¤–åˆ°å†…æ‰§è¡Œ
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Python è£…é¥°å™¨ - å®˜æ–¹æ–‡æ¡£](https://docs.python.org/3.10/glossary.html#term-decorator)
- [PEP 318 - Decorators for Functions and Methods](https://peps.python.org/pep-0318/)
- [PEP 3129 - Class Decorators](https://peps.python.org/pep-3129/)
- [functools - Higher-order functions and operations](https://docs.python.org/3.10/library/functools.html)
- [AgentScope å®˜æ–¹æ–‡æ¡£](https://doc.agentscope.io/)

---

**ç¥ä½ å­¦ä¹ é¡ºåˆ©ï¼ğŸš€**
