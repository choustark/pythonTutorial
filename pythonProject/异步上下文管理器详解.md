# Python å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆasync withï¼‰å®Œå…¨æŒ‡å—

> ä»åŸºç¡€åˆ°å®æˆ˜ï¼Œå…¨é¢æŒæ¡å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨

---

## ğŸ“‹ ç›®å½•

- [1. åŸºç¡€æ¦‚å¿µ](#1-åŸºç¡€æ¦‚å¿µ)
- [2. æ™®é€šä¸Šä¸‹æ–‡ç®¡ç†å™¨å›é¡¾](#2-æ™®é€šä¸Šä¸‹æ–‡ç®¡ç†å™¨å›é¡¾)
- [3. å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨è¯¦è§£](#3-å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨è¯¦è§£)
- [4. å·¥ä½œåŸç†](#4-å·¥ä½œåŸç†)
- [5. å¼‚å¸¸å¤„ç†](#5-å¼‚å¸¸å¤„ç†)
- [6. åµŒå¥—ä½¿ç”¨](#6-åµŒå¥—ä½¿ç”¨)
- [7. AgentScope ä¸­çš„åº”ç”¨](#7-agentscope-ä¸­çš„åº”ç”¨)
- [8. å®æˆ˜ç¤ºä¾‹](#8-å®æˆ˜ç¤ºä¾‹)
- [9. ç»ƒä¹ é¢˜åŠç­”æ¡ˆ](#9-ç»ƒä¹ é¢˜åŠç­”æ¡ˆ)
- [10. æœ€ä½³å®è·µ](#10-æœ€ä½³å®è·µ)

---

## 1. åŸºç¡€æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Ÿ

ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ˜¯ä¸€ç§ç”¨äº**èµ„æºç®¡ç†**çš„ Python æœºåˆ¶ï¼Œç¡®ä¿èµ„æºåœ¨ä½¿ç”¨åèƒ½å¤Ÿ**æ­£ç¡®é‡Šæ”¾**ï¼Œå³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¸ä¾‹å¤–ã€‚

### ä¸ºä»€ä¹ˆè¦å¼‚æ­¥ï¼Ÿ

åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œè·å–å’Œé‡Šæ”¾èµ„æºæœ¬èº«å¯èƒ½ä¹Ÿæ˜¯**å¼‚æ­¥æ“ä½œ**ï¼ˆä¾‹å¦‚ï¼šå»ºç«‹ç½‘ç»œè¿æ¥ã€å…³é—­æ•°æ®åº“è¿æ¥ï¼‰ã€‚è¿™æ—¶å°±éœ€è¦å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚

### å¯¹æ¯”è¡¨

| ç‰¹æ€§ | æ™®é€šä¸Šä¸‹æ–‡ç®¡ç†å™¨ | å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ |
|:----|:---------------|:---------------|
| **å…³é”®å­—** | `with` | `async with` |
| **è¿›å…¥æ–¹æ³•** | `__enter__()` | `__aenter__()` |
| **é€€å‡ºæ–¹æ³•** | `__exit__()` | `__aexit__()` |
| **æ–¹æ³•ç±»å‹** | åŒæ­¥æ–¹æ³• | å¼‚æ­¥æ–¹æ³•ï¼ˆå¿…é¡» awaitï¼‰ |
| **ä½¿ç”¨ç¯å¢ƒ** | ä»»ä½•åœ°æ–¹ | åªèƒ½åœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨ |
| **å…¸å‹åœºæ™¯** | æ–‡ä»¶æ“ä½œã€é” | å¼‚æ­¥è¿æ¥ã€å¼‚æ­¥é”ã€æµå¤„ç† |

---

## 2. æ™®é€šä¸Šä¸‹æ–‡ç®¡ç†å™¨å›é¡¾

åœ¨æ·±å…¥å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¹‹å‰ï¼Œå…ˆå›é¡¾æ™®é€šçš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚

### 2.1 åŸºæœ¬è¯­æ³•

```python
# è¯­æ³•ç»“æ„
with context_manager as variable:
    # åœ¨è¿™é‡Œä½¿ç”¨èµ„æº
    pass
# ç¦»å¼€ with å—åï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾
```

### 2.2 å®ç°æ™®é€šä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
class SimpleContext:
    def __enter__(self):
        """è¿›å…¥ä¸Šä¸‹æ–‡æ—¶è°ƒç”¨"""
        print("è¿›å…¥ä¸Šä¸‹æ–‡")
        return "èµ„æºå¯¹è±¡"  # è¿”å›å€¼ä¼šèµ‹ç»™ as åçš„å˜é‡

    def __exit__(self, exc_type, exc_val, exc_tb):
        """ç¦»å¼€ä¸Šä¸‹æ–‡æ—¶è°ƒç”¨"""
        print("ç¦»å¼€ä¸Šä¸‹æ–‡")
        if exc_type is not None:
            print(f"å‘ç”Ÿå¼‚å¸¸: {exc_type.__name__}")
        # è¿”å› False è¡¨ç¤ºå¼‚å¸¸ç»§ç»­ä¼ æ’­
        # è¿”å› True è¡¨ç¤ºå¼‚å¸¸è¢«æŠ‘åˆ¶
        return False

# ä½¿ç”¨
with SimpleContext() as resource:
    print(f"ä½¿ç”¨èµ„æº: {resource}")
```

**è¾“å‡ºï¼š**
```
è¿›å…¥ä¸Šä¸‹æ–‡
ä½¿ç”¨èµ„æº: èµ„æºå¯¹è±¡
ç¦»å¼€ä¸Šä¸‹æ–‡
```

### 2.3 å®é™…åº”ç”¨ç¤ºä¾‹

```python
# æ–‡ä»¶æ“ä½œ
with open("file.txt", "r") as f:
    content = f.read()
# æ–‡ä»¶è‡ªåŠ¨å…³é—­

# çº¿ç¨‹é”
from threading import Lock
lock = Lock()
with lock:
    # ä¸´ç•ŒåŒºä»£ç 
    pass
# é”è‡ªåŠ¨é‡Šæ”¾

# æ•°æ®åº“è¿æ¥ï¼ˆä½¿ç”¨ contextlibï¼‰
from contextlib import closing
with closing(database.connect()) as conn:
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users")
# è¿æ¥è‡ªåŠ¨å…³é—­
```

---

## 3. å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨è¯¦è§£

### 3.1 åŸºæœ¬è¯­æ³•

```python
# è¯­æ³•ç»“æ„
async with async_context_manager as variable:
    # åœ¨è¿™é‡Œä½¿ç”¨èµ„æº
    pass
# ç¦»å¼€ async with å—åï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾
```

### 3.2 å®ç°å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
import asyncio

class AsyncContext:
    async def __aenter__(self):
        """å¼‚æ­¥è¿›å…¥ä¸Šä¸‹æ–‡"""
        print("æ­£åœ¨å¼‚æ­¥æ‰“å¼€èµ„æº...")
        await asyncio.sleep(1)  # æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
        print("èµ„æºå·²æ‰“å¼€")
        return "å¼‚æ­¥èµ„æºå¯¹è±¡"

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """å¼‚æ­¥é€€å‡ºä¸Šä¸‹æ–‡"""
        print("æ­£åœ¨å¼‚æ­¥å…³é—­èµ„æº...")
        await asyncio.sleep(0.5)  # æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
        print("èµ„æºå·²å…³é—­")
        return False

# ä½¿ç”¨ï¼ˆå¿…é¡»åœ¨å¼‚æ­¥å‡½æ•°ä¸­ï¼‰
async def main():
    async with AsyncContext() as resource:
        print(f"ä½¿ç”¨èµ„æº: {resource}")

asyncio.run(main())
```

**è¾“å‡ºï¼š**
```
æ­£åœ¨å¼‚æ­¥æ‰“å¼€èµ„æº...
èµ„æºå·²æ‰“å¼€
ä½¿ç”¨èµ„æº: å¼‚æ­¥èµ„æºå¯¹è±¡
æ­£åœ¨å¼‚æ­¥å…³é—­èµ„æº...
èµ„æºå·²å…³é—­
```

### 3.3 æ–¹æ³•ç­¾åè¯¦è§£

```python
async def __aenter__(self):
    """
    è¿›å…¥å¼‚æ­¥ä¸Šä¸‹æ–‡æ—¶è°ƒç”¨

    Returns:
        ä»»ä½•å¯¹è±¡ï¼šå°†è¢«èµ‹å€¼ç»™ as åçš„å˜é‡
    """
    pass

async def __aexit__(self, exc_type, exc_val, exc_tb):
    """
    ç¦»å¼€å¼‚æ­¥ä¸Šä¸‹æ–‡æ—¶è°ƒç”¨

    Args:
        exc_type: å¼‚å¸¸ç±»å‹ï¼ˆNone è¡¨ç¤ºæ— å¼‚å¸¸ï¼‰
        exc_val: å¼‚å¸¸å€¼ï¼ˆNone è¡¨ç¤ºæ— å¼‚å¸¸ï¼‰
        exc_tb: å¼‚å¸¸å›æº¯ä¿¡æ¯ï¼ˆNone è¡¨ç¤ºæ— å¼‚å¸¸ï¼‰

    Returns:
        bool: True è¡¨ç¤ºæŠ‘åˆ¶å¼‚å¸¸ï¼ŒFalse è¡¨ç¤ºç»§ç»­ä¼ æ’­å¼‚å¸¸
    """
    pass
```

---

## 4. å·¥ä½œåŸç†

### 4.1 æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         async with AsyncResource() as resource:         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1ï¸âƒ£  è°ƒç”¨ __aenter__() æ–¹æ³•                            â”‚
â”‚      â†“                                                  â”‚
â”‚  2ï¸âƒ£  await __aenter__() ç­‰å¾…å…¶å®Œæˆ                     â”‚
â”‚      â†“                                                  â”‚
â”‚  3ï¸âƒ£  å°† __aenter__() çš„è¿”å›å€¼èµ‹ç»™ resource             â”‚
â”‚      â†“                                                  â”‚
â”‚  4ï¸âƒ£  æ‰§è¡Œ with å—å†…çš„ä»£ç                               â”‚
â”‚      â†“                                                  â”‚
â”‚  5ï¸âƒ£  (æ— è®ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸)                                 â”‚
â”‚      è°ƒç”¨ __aexit__(exc_type, exc_val, exc_tb)          â”‚
â”‚      â†“                                                  â”‚
â”‚  6ï¸âƒ£  await __aexit__() ç­‰å¾…å…¶å®Œæˆ                      â”‚
â”‚      â†“                                                  â”‚
â”‚  7ï¸âƒ£  å¦‚æœ __aexit__ è¿”å› Falseï¼Œå¼‚å¸¸ç»§ç»­ä¼ æ’­            â”‚
â”‚      å¦‚æœ __aexit__ è¿”å› Trueï¼Œå¼‚å¸¸è¢«æŠ‘åˆ¶                â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è¯¦ç»†ç¤ºä¾‹

```python
import asyncio

class DetailedAsyncContext:
    def __init__(self, name):
        self.name = name

    async def __aenter__(self):
        print(f"[{self.name}] Step 1: __aenter__ è¢«è°ƒç”¨")
        await asyncio.sleep(0.5)
        print(f"[{self.name}] Step 2: __aenter__ å®Œæˆ")
        return f"èµ„æº-{self.name}"

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        print(f"[{self.name}] Step 4: __aexit__ è¢«è°ƒç”¨")
        if exc_type:
            print(f"[{self.name}] æ£€æµ‹åˆ°å¼‚å¸¸: {exc_type.__name__}")
        await asyncio.sleep(0.3)
        print(f"[{self.name}] Step 5: __aexit__ å®Œæˆ")
        return False

async def demonstrate():
    print("=== å¼€å§‹æ¼”ç¤º ===")
    async with DetailedAsyncContext("Demo") as resource:
        print(f"[{self.name}] Step 3: ä½¿ç”¨èµ„æº: {resource}")
    print("=== ç»“æŸæ¼”ç¤º ===")

asyncio.run(demonstrate())
```

**è¾“å‡ºï¼š**
```
=== å¼€å§‹æ¼”ç¤º ===
[Demo] Step 1: __aenter__ è¢«è°ƒç”¨
[Demo] Step 2: __aenter__ å®Œæˆ
[Demo] Step 3: ä½¿ç”¨èµ„æº: èµ„æº-Demo
[Demo] Step 4: __aexit__ è¢«è°ƒç”¨
[Demo] Step 5: __aexit__ å®Œæˆ
=== ç»“æŸæ¼”ç¤º ===
```

### 4.3 æ—¶åºå›¾

```
æ—¶é—´çº¿ â†’

Main            __aenter__        With Block        __aexit__
  â”‚                  â”‚                 â”‚                 â”‚
  â”‚  async with ...  â”‚                 â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                 â”‚
  â”‚                  â”‚  await...       â”‚                 â”‚
  â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
  â”‚  è·å¾—èµ„æº         â”‚                 â”‚                 â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚                 â”‚
  â”‚                  â”‚                 â”‚                 â”‚
  â”‚  æ‰§è¡Œä»£ç å—       â”‚                 â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
  â”‚                  â”‚                 â”‚  æ‰§è¡Œä¸­...      â”‚
  â”‚                  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  æ¸…ç†èµ„æº         â”‚                 â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                  â”‚                 â”‚  await...       â”‚
  â”‚                  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  ç»§ç»­æ‰§è¡Œ
```

---

## 5. å¼‚å¸¸å¤„ç†

### 5.1 å¼‚å¸¸å¤„ç†æœºåˆ¶

```python
import asyncio

class ExceptionHandlingContext:
    async def __aenter__(self):
        print("ğŸ“‚ æ‰“å¼€èµ„æº")
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if exc_type is None:
            print("âœ… æ­£å¸¸å…³é—­èµ„æº")
        else:
            print(f"âš ï¸  å‘ç”Ÿå¼‚å¸¸: {exc_type.__name__}: {exc_val}")
            print("ğŸ§¹ æ¸…ç†èµ„æºï¼ˆå³ä½¿æœ‰å¼‚å¸¸ï¼‰")
            # æ¸…ç†æ“ä½œ
            await asyncio.sleep(0.1)

        # è¿”å›å€¼å†³å®šå¼‚å¸¸æ˜¯å¦ç»§ç»­ä¼ æ’­
        return False  # False = ç»§ç»­ä¼ æ’­, True = æŠ‘åˆ¶å¼‚å¸¸

async def test_with_exception():
    async with ExceptionHandlingContext():
        print("ğŸ”§ ä½¿ç”¨èµ„æºä¸­...")
        raise ValueError("æ¨¡æ‹Ÿçš„é”™è¯¯ï¼")
        print("è¿™è¡Œä¸ä¼šæ‰§è¡Œ")

asyncio.run(test_with_exception())
```

**è¾“å‡ºï¼š**
```
ğŸ“‚ æ‰“å¼€èµ„æº
ğŸ”§ ä½¿ç”¨èµ„æºä¸­...
âš ï¸  å‘ç”Ÿå¼‚å¸¸: ValueError: æ¨¡æ‹Ÿçš„é”™è¯¯ï¼
ğŸ§¹ æ¸…ç†èµ„æºï¼ˆå³ä½¿æœ‰å¼‚å¸¸ï¼‰
Traceback (most recent call last):
  ...
ValueError: æ¨¡æ‹Ÿçš„é”™è¯¯ï¼
```

### 5.2 æŠ‘åˆ¶å¼‚å¸¸

```python
import asyncio

class SuppressExceptionContext:
    async def __aenter__(self):
        print("è¿›å…¥ä¸Šä¸‹æ–‡")
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if exc_type:
            print(f"æ•è·å¼‚å¸¸: {exc_type.__name__}")
            print("æŠ‘åˆ¶å¼‚å¸¸ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œ")
            return True  # è¿”å› True æŠ‘åˆ¶å¼‚å¸¸
        return False

async def test_suppress_exception():
    async with SuppressExceptionContext():
        print("æŠ›å‡ºå¼‚å¸¸...")
        raise ValueError("è¿™ä¸ªå¼‚å¸¸ä¼šè¢«æŠ‘åˆ¶")

    print("ç¨‹åºç»§ç»­æ‰§è¡Œï¼å¼‚å¸¸å·²è¢«æŠ‘åˆ¶")

asyncio.run(test_suppress_exception())
```

**è¾“å‡ºï¼š**
```
è¿›å…¥ä¸Šä¸‹æ–‡
æŠ›å‡ºå¼‚å¸¸...
æ•è·å¼‚å¸¸: ValueError
æŠ‘åˆ¶å¼‚å¸¸ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œ
ç¨‹åºç»§ç»­æ‰§è¡Œï¼å¼‚å¸¸å·²è¢«æŠ‘åˆ¶
```

### 5.3 å®é™…åº”ç”¨ï¼šå®‰å…¨çš„æ•°æ®åº“è¿æ¥

```python
import asyncio

class SafeDatabaseConnection:
    """å®‰å…¨çš„æ•°æ®åº“è¿æ¥ï¼Œç¡®ä¿å‘ç”Ÿå¼‚å¸¸æ—¶ä¹Ÿèƒ½æ­£ç¡®å…³é—­"""

    def __init__(self, host, port):
        self.host = host
        self.port = port
        self.connection = None

    async def __aenter__(self):
        try:
            print(f"ğŸ”Œ è¿æ¥åˆ° {self.host}:{self.port}...")
            await asyncio.sleep(1)  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            self.connection = f"DBè¿æ¥({self.host}:{self.port})"
            print("âœ… è¿æ¥æˆåŠŸ")
            return self.connection
        except Exception as e:
            print(f"âŒ è¿æ¥å¤±è´¥: {e}")
            raise

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if self.connection:
            print(f"ğŸ”Œ å…³é—­è¿æ¥: {self.connection}")
            await asyncio.sleep(0.5)
            self.connection = None
            print("âœ… è¿æ¥å·²å…³é—­")
        return False  # ä¸æŠ‘åˆ¶å¼‚å¸¸

async def query_database():
    """æŸ¥è¯¢æ•°æ®åº“ï¼Œå¯èƒ½å‘ç”Ÿå¼‚å¸¸"""
    async with SafeDatabaseConnection("localhost", 5432) as conn:
        print(f"ğŸ“Š ä½¿ç”¨è¿æ¥: {conn}")
        print("æ‰§è¡ŒæŸ¥è¯¢...")
        # æ¨¡æ‹ŸæŸ¥è¯¢è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸
        raise RuntimeError("æŸ¥è¯¢è¶…æ—¶ï¼")

asyncio.run(query_database())
```

**è¾“å‡ºï¼š**
```
ğŸ”Œ è¿æ¥åˆ° localhost:5432...
âœ… è¿æ¥æˆåŠŸ
ğŸ“Š ä½¿ç”¨è¿æ¥: DBè¿æ¥(localhost:5432)
æ‰§è¡ŒæŸ¥è¯¢...
ğŸ”Œ å…³é—­è¿æ¥: DBè¿æ¥(localhost:5432)
âœ… è¿æ¥å·²å…³é—­
Traceback (most recent call last):
  ...
RuntimeError: æŸ¥è¯¢è¶…æ—¶ï¼
```

**å…³é”®ç‚¹ï¼š** å³ä½¿å‘ç”ŸæŸ¥è¯¢è¶…æ—¶å¼‚å¸¸ï¼Œè¿æ¥ä¹Ÿèƒ½æ­£ç¡®å…³é—­ï¼

---

## 6. åµŒå¥—ä½¿ç”¨

### 6.1 åŸºæœ¬åµŒå¥—

```python
import asyncio

class ResourceA:
    async def __aenter__(self):
        print("  ğŸ“‚ æ‰“å¼€èµ„æº A")
        await asyncio.sleep(0.2)
        return "A"

    async def __aexit__(self, *args):
        print("  ğŸ“ å…³é—­èµ„æº A")
        await asyncio.sleep(0.2)

class ResourceB:
    async def __aenter__(self):
        print("    ğŸ“¦ æ‰“å¼€èµ„æº B")
        await asyncio.sleep(0.2)
        return "B"

    async def __aexit__(self, *args):
        print("    ğŸ“¥ å…³é—­èµ„æº B")
        await asyncio.sleep(0.2)

async def nested_example():
    """åµŒå¥—ä½¿ç”¨"""
    async with ResourceA() as a:
        async with ResourceB() as b:
            print(f"    ğŸ’¡ ä½¿ç”¨èµ„æº: {a} å’Œ {b}")
            await asyncio.sleep(0.5)

asyncio.run(nested_example())
```

**è¾“å‡ºï¼š**
```
  ğŸ“‚ æ‰“å¼€èµ„æº A
    ğŸ“¦ æ‰“å¼€èµ„æº B
    ğŸ’¡ ä½¿ç”¨èµ„æº: A å’Œ B
    ğŸ“¥ å…³é—­èµ„æº B
  ğŸ“ å…³é—­èµ„æº A
```

### 6.2 å¹¶è¡Œæ‰“å¼€ï¼ˆPython 3.10+ï¼‰

```python
import asyncio

class Resource:
    def __init__(self, name, delay=0.5):
        self.name = name
        self.delay = delay

    async def __aenter__(self):
        print(f"  ğŸ“‚ æ‰“å¼€ {self.name}...")
        await asyncio.sleep(self.delay)
        print(f"  âœ… {self.name} å·²æ‰“å¼€")
        return self.name

    async def __aexit__(self, *args):
        print(f"  ğŸ“ å…³é—­ {self.name}")
        await asyncio.sleep(0.3)

async def parallel_open():
    """å¹¶è¡Œæ‰“å¼€å¤šä¸ªèµ„æºï¼ˆPython 3.10+ï¼‰"""
    print("=== å¹¶è¡Œæ‰“å¼€ ===")

    # ä½¿ç”¨æ‹¬å·åŒæ—¶æ‰“å¼€å¤šä¸ªèµ„æº
    async with (
        Resource("A", 0.5) as a,
        Resource("B", 0.5) as b,
        Resource("C", 0.5) as c,
    ):
        print(f"ğŸ’¡ ä½¿ç”¨èµ„æº: {a}, {b}, {c}")
        await asyncio.sleep(0.5)

    print("=== å®Œæˆ ===")

asyncio.run(parallel_open())
```

**è¾“å‡ºï¼š**
```
=== å¹¶è¡Œæ‰“å¼€ ===
  ğŸ“‚ æ‰“å¼€ A...
  ğŸ“‚ æ‰“å¼€ B...
  ğŸ“‚ æ‰“å¼€ C...
  âœ… A å·²æ‰“å¼€
  âœ… B å·²æ‰“å¼€
  âœ… C å·²æ‰“å¼€
ğŸ’¡ ä½¿ç”¨èµ„æº: A, B, C
  ğŸ“ å…³é—­ A
  ğŸ“ å…³é—­ B
  ğŸ“ å…³é—­ C
=== å®Œæˆ ===
```

### 6.3 æ€§èƒ½å¯¹æ¯”

```python
import asyncio
import time

class SlowResource:
    def __init__(self, name):
        self.name = name

    async def __aenter__(self):
        await asyncio.sleep(1)  # æ¨¡æ‹Ÿæ…¢é€Ÿæ“ä½œ
        return self.name

    async def __aexit__(self, *args):
        await asyncio.sleep(0.5)

async def sequential_open():
    """é¡ºåºæ‰“å¼€"""
    start = time.time()
    async with SlowResource("A") as a:
        async with SlowResource("B") as b:
            async with SlowResource("C") as c:
                pass
    return time.time() - start

async def parallel_open():
    """å¹¶è¡Œæ‰“å¼€"""
    start = time.time()
    async with (
        SlowResource("A") as a,
        SlowResource("B") as b,
        SlowResource("C") as c,
    ):
        pass
    return time.time() - start

async def compare():
    print("é¡ºåºæ‰“å¼€è€—æ—¶:", await sequential_open())  # çº¦ 4.5 ç§’
    print("å¹¶è¡Œæ‰“å¼€è€—æ—¶:", await parallel_open())    # çº¦ 1.5 ç§’

asyncio.run(compare())
```

---

## 7. AgentScope ä¸­çš„åº”ç”¨

### 7.1 MsgHubï¼šå¤šæ™ºèƒ½ä½“æ¶ˆæ¯ä¸­å¿ƒ

```python
from agentscope.pipeline import MsgHub
from agentscope.message import Msg
from agentscope.agent import ReActAgent

async def multi_agent_chat():
    # åˆ›å»ºå¤šä¸ª Agent
    alice = ReActAgent(name="Alice", ...)
    bob = ReActAgent(name="Bob", ...)
    charlie = ReActAgent(name="Charlie", ...)

    # MsgHub ç®¡ç†å¤š Agent å¯¹è¯
    async with MsgHub(
        participants=[alice, bob, charlie],
        announcement=Msg("Host", "è¯·è‡ªæˆ‘ä»‹ç»", "assistant")
    ) as hub:
        # åœ¨ with å—å†…ï¼Œå¯ä»¥ç®¡ç†å¯¹è¯

        # åŠ¨æ€æ·»åŠ å‚ä¸è€…
        dave = ReActAgent(name="Dave", ...)
        hub.add(dave)

        # å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å‚ä¸è€…
        await hub.broadcast(
            Msg("Host", "è®¨è®ºå¼€å§‹äº†ï¼", "assistant")
        )

        # ç§»é™¤å‚ä¸è€…
        hub.delete(charlie)

    # ç¦»å¼€ async with åï¼ŒMsgHub è‡ªåŠ¨æ¸…ç†æ‰€æœ‰è¿æ¥
```

**ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Ÿ**

1. **å¼‚æ­¥åˆå§‹åŒ–**ï¼šå»ºç«‹å¤šä¸ª Agent ä¹‹é—´çš„æ¶ˆæ¯é€šé“éœ€è¦å¼‚æ­¥æ“ä½œ
2. **å¼‚æ­¥æ¸…ç†**ï¼šå…³é—­æ‰€æœ‰è¿æ¥éœ€è¦å¼‚æ­¥æ“ä½œ
3. **å¼‚å¸¸å®‰å…¨**ï¼šå³ä½¿å¯¹è¯ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿèƒ½æ­£ç¡®æ¸…ç†èµ„æº

### 7.2 å¼‚æ­¥ Agent æœåŠ¡

```python
from agentscope_runtime.engine import AgentApp
from agentscope_runtime.engine.services.session_history import (
    InMemorySessionHistoryService,
)

agent_app = AgentApp(
    app_name="MyAgent",
    app_description="æˆ‘çš„æ™ºèƒ½åŠ©æ‰‹",
)

@agent_app.init
async def init_func(self):
    """æœåŠ¡å¯åŠ¨æ—¶çš„åˆå§‹åŒ–"""
    # åˆ›å»ºå¼‚æ­¥æœåŠ¡
    self.session_service = InMemorySessionHistoryService()
    await self.session_service.start()  # å¼‚æ­¥å¯åŠ¨
    print("âœ… æœåŠ¡åˆå§‹åŒ–å®Œæˆ")

@agent_app.shutdown
async def shutdown_func(self):
    """æœåŠ¡å…³é—­æ—¶çš„æ¸…ç†"""
    await self.session_service.stop()  # å¼‚æ­¥åœæ­¢
    print("âœ… æœåŠ¡æ¸…ç†å®Œæˆ")

@agent_app.query(framework="agentscope")
async def query_func(self, msgs, request=None, **kwargs):
    """å¤„ç†æŸ¥è¯¢"""
    # ä½¿ç”¨åˆå§‹åŒ–å¥½çš„æœåŠ¡
    sessions = await self.session_service.get_sessions(...)
    return sessions
```

---

## 8. å®æˆ˜ç¤ºä¾‹

### 8.1 å¼‚æ­¥æ–‡ä»¶å†™å…¥å™¨

```python
import asyncio

class AsyncFileWriter:
    """å¼‚æ­¥æ–‡ä»¶å†™å…¥å™¨"""

    def __init__(self, filename, mode='w'):
        self.filename = filename
        self.mode = mode
        self.file = None

    async def __aenter__(self):
        # å°†åŒæ­¥çš„ open è½¬ä¸ºå¼‚æ­¥
        loop = asyncio.get_event_loop()
        self.file = await loop.run_in_executor(
            None,  # ä½¿ç”¨é»˜è®¤æ‰§è¡Œå™¨
            open,
            self.filename,
            self.mode
        )
        print(f"ğŸ“‚ æ–‡ä»¶å·²æ‰“å¼€: {self.filename}")
        return self

    async def write(self, content):
        """å¼‚æ­¥å†™å…¥"""
        loop = asyncio.get_event_loop()
        await loop.run_in_executor(
            None,
            self.file.write,
            content
        )

    async def __aexit__(self, *args):
        if self.file:
            self.file.close()
            print(f"ğŸ“ æ–‡ä»¶å·²å…³é—­: {self.filename}")
        return False

async def write_file_example():
    async with AsyncFileWriter("output.txt") as writer:
        await writer.write("ç¬¬ä¸€è¡Œ\n")
        await writer.write("ç¬¬äºŒè¡Œ\n")
        await writer.write("ç¬¬ä¸‰è¡Œ\n")

asyncio.run(write_file_example())
```

### 8.2 å¼‚æ­¥è¿æ¥æ± 

```python
import asyncio
from typing import Optional

class AsyncConnectionPool:
    """å¼‚æ­¥è¿æ¥æ± """

    def __init__(self, max_size=5):
        self.max_size = max_size
        self.connections = []
        self.active = 0

    async def __aenter__(self):
        print(f"ğŸ”Œ åˆå§‹åŒ–è¿æ¥æ± ï¼ˆæœ€å¤§ {self.max_size} ä¸ªï¼‰")
        await asyncio.sleep(0.5)
        for i in range(self.max_size):
            self.connections.append(f"conn-{i+1}")
        print(f"âœ… è¿æ¥æ± å°±ç»ª")
        return self

    async def acquire(self) -> str:
        """è·å–ä¸€ä¸ªè¿æ¥"""
        while self.active >= self.max_size:
            print("â³ ç­‰å¾…å¯ç”¨è¿æ¥...")
            await asyncio.sleep(0.1)
        conn = self.connections[self.active]
        self.active += 1
        print(f"  ğŸ“Œ è·å–è¿æ¥: {conn} (æ´»è·ƒ: {self.active})")
        return conn

    async def release(self, conn: str):
        """é‡Šæ”¾è¿æ¥"""
        self.active -= 1
        print(f"  ğŸ”“ é‡Šæ”¾è¿æ¥: {conn} (æ´»è·ƒ: {self.active})")

    async def __aexit__(self, *args):
        print("ğŸ§¹ å…³é—­è¿æ¥æ± ...")
        await asyncio.sleep(0.5)
        self.connections.clear()
        print("âœ… è¿æ¥æ± å·²å…³é—­")
        return False

async def use_pool():
    async with AsyncConnectionPool(max_size=2) as pool:
        async def task(name, duration):
            conn = await pool.acquire()
            await asyncio.sleep(duration)
            await pool.release(conn)
            print(f"  âœ… {name} å®Œæˆ")

        await asyncio.gather(
            task("ä»»åŠ¡A", 2),
            task("ä»»åŠ¡B", 1),
            task("ä»»åŠ¡C", 1.5),
        )

asyncio.run(use_pool())
```

### 8.3 å¼‚æ­¥è®¡æ—¶å™¨

```python
import asyncio
import time

class AsyncTimer:
    """å¼‚æ­¥è®¡æ—¶å™¨"""

    def __init__(self, name="æ“ä½œ"):
        self.name = name
        self.start_time = None
        self.end_time = None

    async def __aenter__(self):
        self.start_time = time.time()
        print(f"â±ï¸  {self.name} å¼€å§‹...")
        return self

    async def __aexit__(self, *args):
        self.end_time = time.time()
        elapsed = self.end_time - self.start_time
        print(f"â±ï¸  {self.name} å®Œæˆï¼Œè€—æ—¶: {elapsed:.2f} ç§’")
        return False

async def timer_example():
    async with AsyncTimer("æ•°æ®å¤„ç†"):
        # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        await asyncio.sleep(1.5)

asyncio.run(timer_example())
```

**è¾“å‡ºï¼š**
```
â±ï¸  æ•°æ®å¤„ç† å¼€å§‹...
â±ï¸  æ•°æ®å¤„ç† å®Œæˆï¼Œè€—æ—¶: 1.50 ç§’
```

### 8.4 å¼‚æ­¥é”çš„ä½¿ç”¨

```python
import asyncio

class AsyncLockManager:
    """å¼‚æ­¥é”ç®¡ç†å™¨"""

    def __init__(self, lock):
        self.lock = lock

    async def __aenter__(self):
        print(f"ğŸ”’ å°è¯•è·å–é”...")
        await self.lock.acquire()
        print(f"âœ… é”å·²è·å–")
        return self

    async def __aexit__(self, *args):
        self.lock.release()
        print(f"ğŸ”“ é”å·²é‡Šæ”¾")
        return False

async def critical_section(name, lock):
    """ä¸´ç•ŒåŒºæ“ä½œ"""
    async with AsyncLockManager(lock):
        print(f"ğŸ“Œ {name} è¿›å…¥ä¸´ç•ŒåŒº")
        await asyncio.sleep(1)
        print(f"ğŸ“Œ {name} ç¦»å¼€ä¸´ç•ŒåŒº")

async def lock_example():
    lock = asyncio.Lock()
    await asyncio.gather(
        critical_section("ä»»åŠ¡A", lock),
        critical_section("ä»»åŠ¡B", lock),
    )

asyncio.run(lock_example())
```

**è¾“å‡ºï¼š**
```
ğŸ”’ å°è¯•è·å–é”...
âœ… é”å·²è·å–
ğŸ“Œ ä»»åŠ¡A è¿›å…¥ä¸´ç•ŒåŒº
ğŸ”’ å°è¯•è·å–é”...  # ä»»åŠ¡B ç­‰å¾…
ğŸ“Œ ä»»åŠ¡A ç¦»å¼€ä¸´ç•ŒåŒº
ğŸ”“ é”å·²é‡Šæ”¾
âœ… é”å·²è·å–
ğŸ“Œ ä»»åŠ¡B è¿›å…¥ä¸´ç•ŒåŒº
ğŸ“Œ ä»»åŠ¡B ç¦»å¼€ä¸´ç•ŒåŒº
ğŸ”“ é”å·²é‡Šæ”¾
```

---

## 9. ç»ƒä¹ é¢˜åŠç­”æ¡ˆ

### ç»ƒä¹  1ï¼šå¼‚æ­¥æ–‡ä»¶å†™å…¥å™¨

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªå¼‚æ­¥æ–‡ä»¶å†™å…¥å™¨ï¼Œæ”¯æŒå¤šè¡Œå†™å…¥å¹¶è‡ªåŠ¨å…³é—­æ–‡ä»¶ã€‚

```python
import asyncio

class AsyncFileWriter:
    """å¼‚æ­¥æ–‡ä»¶å†™å…¥å™¨

    åŠŸèƒ½ï¼š
    1. å¼‚æ­¥æ‰“å¼€æ–‡ä»¶
    2. æ”¯æŒå†™å…¥å¤šè¡Œå†…å®¹
    3. è‡ªåŠ¨å…³é—­æ–‡ä»¶
    4. å¼‚å¸¸æ—¶ä¹Ÿè¦ç¡®ä¿æ–‡ä»¶å…³é—­
    """

    def __init__(self, filename, mode='w'):
        self.filename = filename
        self.mode = mode
        self.file = None

    # TODO: å®ç° __aenter__ æ–¹æ³•

    # TODO: å®ç° write æ–¹æ³•

    # TODO: å®ç° __aexit__ æ–¹æ³•
```

**ç­”æ¡ˆï¼š**

```python
import asyncio

class AsyncFileWriter:
    def __init__(self, filename, mode='w'):
        self.filename = filename
        self.mode = mode
        self.file = None

    async def __aenter__(self):
        """å¼‚æ­¥æ‰“å¼€æ–‡ä»¶"""
        loop = asyncio.get_event_loop()
        self.file = await loop.run_in_executor(
            None,
            open,
            self.filename,
            self.mode
        )
        print(f"âœ… æ–‡ä»¶å·²æ‰“å¼€: {self.filename}")
        return self

    async def write(self, content):
        """å¼‚æ­¥å†™å…¥å†…å®¹"""
        loop = asyncio.get_event_loop()
        await loop.run_in_executor(
            None,
            self.file.write,
            content
        )

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """å¼‚æ­¥å…³é—­æ–‡ä»¶"""
        if exc_type:
            print(f"âš ï¸  å‘ç”Ÿå¼‚å¸¸: {exc_type.__name__}")
        if self.file:
            self.file.close()
            print(f"ğŸ“ æ–‡ä»¶å·²å…³é—­: {self.filename}")
        return False

# æµ‹è¯•
async def test():
    async with AsyncFileWriter("test.txt") as writer:
        await writer.write("ç¬¬ä¸€è¡Œ\n")
        await writer.write("ç¬¬äºŒè¡Œ\n")
        await writer.write("ç¬¬ä¸‰è¡Œ\n")
    print("âœ… å†™å…¥å®Œæˆ")

asyncio.run(test())
```

---

### ç»ƒä¹  2ï¼šå¼‚æ­¥è®¡æ—¶å™¨

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªå¼‚æ­¥è®¡æ—¶å™¨ï¼Œæµ‹é‡ä»£ç å—çš„æ‰§è¡Œæ—¶é—´ã€‚

```python
import asyncio
import time

class AsyncTimer:
    """å¼‚æ­¥è®¡æ—¶å™¨

    åŠŸèƒ½ï¼š
    1. è®°å½•å¼€å§‹æ—¶é—´
    2. æ‰§è¡Œä»£ç å—
    3. è®¡ç®—å¹¶æ‰“å°è€—æ—¶
    """

    # TODO: å®ç°å®Œæ•´ç±»
```

**ç­”æ¡ˆï¼š**

```python
import asyncio
import time

class AsyncTimer:
    """å¼‚æ­¥è®¡æ—¶å™¨"""

    def __init__(self, name="æ“ä½œ"):
        self.name = name
        self.start_time = None
        self.end_time = None

    async def __aenter__(self):
        """è®°å½•å¼€å§‹æ—¶é—´"""
        self.start_time = time.time()
        print(f"â±ï¸  [{self.name}] å¼€å§‹...")
        return self

    def elapsed(self):
        """è·å–å·²è¿‡æ—¶é—´"""
        if self.start_time:
            current = self.end_time if self.end_time else time.time()
            return current - self.start_time
        return 0

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """è®¡ç®—å¹¶æ‰“å°æ€»è€—æ—¶"""
        self.end_time = time.time()
        total_time = self.end_time - self.start_time
        print(f"â±ï¸  [{self.name}] å®Œæˆï¼Œæ€»è€—æ—¶: {total_time:.2f} ç§’")
        return False

# æµ‹è¯•
async def test():
    async with AsyncTimer("æ•°æ®å¤„ç†") as timer:
        await asyncio.sleep(1)
        print(f"  ä¸­é—´å·²è¿‡æ—¶é—´: {timer.elapsed():.2f} ç§’")
        await asyncio.sleep(0.5)

asyncio.run(test())
```

**è¾“å‡ºï¼š**
```
â±ï¸  [æ•°æ®å¤„ç†] å¼€å§‹...
  ä¸­é—´å·²è¿‡æ—¶é—´: 1.00 ç§’
â±ï¸  [æ•°æ®å¤„ç†] å®Œæˆï¼Œæ€»è€—æ—¶: 1.50 ç§’
```

---

### ç»ƒä¹  3ï¼šå¼‚æ­¥é‡è¯•æœºåˆ¶

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªå¼‚æ­¥é‡è¯•ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œåœ¨æ“ä½œå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ã€‚

```python
import asyncio

class AsyncRetry:
    """å¼‚æ­¥é‡è¯•ä¸Šä¸‹æ–‡ç®¡ç†å™¨

    åŠŸèƒ½ï¼š
    1. æ•è·å¼‚å¸¸
    2. è‡ªåŠ¨é‡è¯•æŒ‡å®šæ¬¡æ•°
    3. é‡è¯•ä¹‹é—´æœ‰å»¶è¿Ÿ
    """

    def __init__(self, max_retries=3, delay=1.0):
        self.max_retries = max_retries
        self.delay = delay

    # TODO: å®ç°å®Œæ•´ç±»
```

**ç­”æ¡ˆï¼š**

```python
import asyncio

class AsyncRetry:
    """å¼‚æ­¥é‡è¯•ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""

    def __init__(self, max_retries=3, delay=1.0, exceptions=(Exception,)):
        self.max_retries = max_retries
        self.delay = delay
        self.exceptions = exceptions
        self.attempt = 0

    async def __aenter__(self):
        self.attempt = 0
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """å¤„ç†å¼‚å¸¸å¹¶å†³å®šæ˜¯å¦é‡è¯•"""
        if exc_type is None:
            # æ²¡æœ‰å¼‚å¸¸ï¼ŒæˆåŠŸå®Œæˆ
            return False

        if not issubclass(exc_type, self.exceptions):
            # ä¸æ˜¯è¦å¤„ç†çš„å¼‚å¸¸ç±»å‹ï¼Œç›´æ¥ä¼ æ’­
            return False

        self.attempt += 1
        if self.attempt >= self.max_retries:
            # å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
            print(f"âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° ({self.max_retries})ï¼Œæ”¾å¼ƒ")
            return False

        # é‡è¯•
        print(f"âš ï¸  ç¬¬ {self.attempt} æ¬¡å¤±è´¥: {exc_val}")
        print(f"ğŸ”„ {self.delay} ç§’åé‡è¯•...")
        await asyncio.sleep(self.delay)

        # æŠ‘åˆ¶å¼‚å¸¸ï¼Œè®©å¤–å±‚ä»£ç é‡æ–°æ‰§è¡Œ
        # æ³¨æ„ï¼šè¿™éœ€è¦é…åˆç‰¹å®šçš„é‡è¯•é€»è¾‘
        return True

# ä½¿ç”¨ç¤ºä¾‹ï¼ˆéœ€è¦æ³¨æ„é‡è¯•é€»è¾‘çš„å®ç°ï¼‰
async def unreliable_operation():
    """ä¸å¯é çš„æ“ä½œ"""
    import random
    if random.random() < 0.7:  # 70% å¤±è´¥ç‡
        raise ConnectionError("è¿æ¥å¤±è´¥ï¼")
    print("âœ… æ“ä½œæˆåŠŸï¼")

async def test_retry():
    """æµ‹è¯•é‡è¯•æœºåˆ¶"""
    max_attempts = 3
    for attempt in range(max_attempts):
        try:
            async with AsyncRetry(max_retries=3, delay=0.5):
                await unreliable_operation()
                break  # æˆåŠŸåˆ™é€€å‡º
        except Exception as e:
            if attempt == max_attempts - 1:
                print(f"âŒ æœ€ç»ˆå¤±è´¥: {e}")

asyncio.run(test_retry())
```

---

### ç»ƒä¹  4ï¼šå¼‚æ­¥æ•°æ®åº“äº‹åŠ¡

**é¢˜ç›®ï¼š** å®ç°ä¸€ä¸ªå¼‚æ­¥æ•°æ®åº“äº‹åŠ¡ç®¡ç†å™¨ã€‚

```python
import asyncio

class AsyncTransaction:
    """å¼‚æ­¥æ•°æ®åº“äº‹åŠ¡ç®¡ç†å™¨

    åŠŸèƒ½ï¼š
    1. å¼€å§‹äº‹åŠ¡
    2. æäº¤æˆ–å›æ»š
    3. å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»š
    """

    def __init__(self, connection):
        self.connection = connection

    # TODO: å®ç°å®Œæ•´ç±»
```

**ç­”æ¡ˆï¼š**

```python
import asyncio

class MockConnection:
    """æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥"""

    def __init__(self):
        self.in_transaction = False
        self.committed = False
        self.rolled_back = False

    async def begin(self):
        await asyncio.sleep(0.1)
        self.in_transaction = True
        print("  ğŸ“ äº‹åŠ¡å¼€å§‹")

    async def commit(self):
        await asyncio.sleep(0.1)
        self.committed = True
        self.in_transaction = False
        print("  âœ… äº‹åŠ¡å·²æäº¤")

    async def rollback(self):
        await asyncio.sleep(0.1)
        self.rolled_back = True
        self.in_transaction = False
        print("  â†©ï¸  äº‹åŠ¡å·²å›æ»š")

class AsyncTransaction:
    """å¼‚æ­¥æ•°æ®åº“äº‹åŠ¡ç®¡ç†å™¨"""

    def __init__(self, connection):
        self.connection = connection
        self.success = False

    async def __aenter__(self):
        """å¼€å§‹äº‹åŠ¡"""
        await self.connection.begin()
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """æäº¤æˆ–å›æ»šäº‹åŠ¡"""
        if exc_type is None:
            # æ²¡æœ‰å¼‚å¸¸ï¼Œæäº¤
            await self.connection.commit()
            self.success = True
        else:
            # æœ‰å¼‚å¸¸ï¼Œå›æ»š
            print(f"  âš ï¸  å¼‚å¸¸å‘ç”Ÿ: {exc_type.__name__}")
            await self.connection.rollback()
        return False  # ä¸æŠ‘åˆ¶å¼‚å¸¸

async def transfer_money(conn, from_account, to_account, amount):
    """è½¬è´¦æ“ä½œ"""
    async with AsyncTransaction(conn) as tx:
        print(f"  ğŸ’³ ä» {from_account} è½¬è´¦ {amount} åˆ° {to_account}")
        await asyncio.sleep(0.5)
        # æ¨¡æ‹Ÿå¯èƒ½å¤±è´¥çš„æ“ä½œ
        if amount > 1000:
            raise ValueError("è½¬è´¦é‡‘é¢è¶…é™ï¼")
        print("  ğŸ’° è½¬è´¦æˆåŠŸ")

async def test_transaction():
    """æµ‹è¯•äº‹åŠ¡"""
    conn = MockConnection()

    # æˆåŠŸçš„äº‹åŠ¡
    print("=== æˆåŠŸçš„äº‹åŠ¡ ===")
    await transfer_money(conn, "A", "B", 500)
    print(f"æäº¤çŠ¶æ€: {conn.committed}, å›æ»šçŠ¶æ€: {conn.rolled_back}\n")

    # å¤±è´¥çš„äº‹åŠ¡
    print("=== å¤±è´¥çš„äº‹åŠ¡ ===")
    conn = MockConnection()
    try:
        await transfer_money(conn, "A", "B", 1500)
    except ValueError as e:
        print(f"æ•è·åˆ°å¼‚å¸¸: {e}")
    print(f"æäº¤çŠ¶æ€: {conn.committed}, å›æ»šçŠ¶æ€: {conn.rolled_back}")

asyncio.run(test_transaction())
```

**è¾“å‡ºï¼š**
```
=== æˆåŠŸçš„äº‹åŠ¡ ===
  ğŸ“ äº‹åŠ¡å¼€å§‹
  ğŸ’³ ä» A è½¬è´¦ 500 åˆ° B
  ğŸ’° è½¬è´¦æˆåŠŸ
  âœ… äº‹åŠ¡å·²æäº¤
æäº¤çŠ¶æ€: True, å›æ»šçŠ¶æ€: False

=== å¤±è´¥çš„äº‹åŠ¡ ===
  ğŸ“ äº‹åŠ¡å¼€å§‹
  ğŸ’³ ä» A è½¬è´¦ 1500 åˆ° B
  âš ï¸  å¼‚å¸¸å‘ç”Ÿ: ValueError
  â†©ï¸  äº‹åŠ¡å·²å›æ»š
æ•è·åˆ°å¼‚å¸¸: è½¬è´¦é‡‘é¢è¶…é™ï¼
æäº¤çŠ¶æ€: False, å›æ»šçŠ¶æ€: True
```

---

## 10. æœ€ä½³å®è·µ

### 10.1 å‘½åè§„èŒƒ

```python
# âœ… å¥½çš„å‘½å
class AsyncDatabaseConnection:
    """æ¸…æ™°çš„åç§°è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    pass

# âŒ ä¸å¥½çš„å‘½å
class Connection:
    """æ— æ³•ä»åç§°åˆ¤æ–­æ˜¯å¦ä¸ºå¼‚æ­¥"""
    pass
```

### 10.2 èµ„æºæ¸…ç†é¡ºåº

```python
class ProperAsyncContext:
    async def __aenter__(self):
        """æŒ‰ä¾èµ–é¡ºåºè·å–èµ„æº"""
        self.resource1 = await acquire_resource1()
        self.resource2 = await acquire_resource2()  # ä¾èµ– resource1
        return self

    async def __aexit__(self, *args):
        """æŒ‰ç›¸åé¡ºåºé‡Šæ”¾èµ„æº"""
        try:
            if hasattr(self, 'resource2'):
                await release_resource2(self.resource2)
        finally:
            if hasattr(self, 'resource1'):
                await release_resource1(self.resource1)
        return False
```

### 10.3 å¼‚å¸¸å®‰å…¨

```python
class SafeAsyncContext:
    async def __aenter__(self):
        try:
            self.resource = await acquire_resource()
            return self.resource
        except Exception as e:
            # å¦‚æœè·å–èµ„æºå¤±è´¥ï¼Œç¡®ä¿æ¸…ç†å·²åˆ†é…çš„éƒ¨åˆ†èµ„æº
            await cleanup_partial_resources()
            raise

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        # æ— è®ºæ˜¯å¦å¼‚å¸¸ï¼Œéƒ½ç¡®ä¿æ¸…ç†èµ„æº
        try:
            await cleanup(self.resource)
        except Exception as cleanup_error:
            # è®°å½•æ¸…ç†é”™è¯¯ï¼Œä½†ä¸å½±å“åŸå§‹å¼‚å¸¸
            print(f"æ¸…ç†é”™è¯¯: {cleanup_error}")
        return False  # ç»§ç»­ä¼ æ’­åŸå§‹å¼‚å¸¸
```

### 10.4 é¿å…åœ¨ `__aenter__` ä¸­é˜»å¡

```python
# âŒ ä¸å¥½ï¼šåœ¨ __aenter__ ä¸­è¿›è¡ŒåŒæ­¥é˜»å¡æ“ä½œ
class BadAsyncContext:
    async def __aenter__(self):
        time.sleep(5)  # é˜»å¡ 5 ç§’ï¼
        return self

# âœ… å¥½ï¼šä½¿ç”¨å¼‚æ­¥æ“ä½œ
class GoodAsyncContext:
    async def __aenter__(self):
        await asyncio.sleep(5)  # éé˜»å¡
        return self

# âœ… æˆ–ä½¿ç”¨ executor åŒ…è£…åŒæ­¥æ“ä½œ
class GoodAsyncContext2:
    async def __aenter__(self):
        loop = asyncio.get_event_loop()
        await loop.run_in_executor(None, time.sleep, 5)
        return self
```

### 10.5 è°ƒè¯•æŠ€å·§

```python
class DebugAsyncContext:
    """å¸¦è°ƒè¯•ä¿¡æ¯çš„å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""

    def __init__(self, name, debug=True):
        self.name = name
        self.debug = debug

    async def __aenter__(self):
        if self.debug:
            print(f"[{self.name}] __aenter__ å¼€å§‹")
            import traceback
            traceback.print_stack()
        result = await self._actual_enter()
        if self.debug:
            print(f"[{self.name}] __aenter__ å®Œæˆ")
        return result

    async def _actual_enter(self):
        """å®é™…çš„è¿›å…¥é€»è¾‘"""
        # ... å®é™…ä»£ç 
        pass

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if self.debug:
            print(f"[{self.name}] __aexit__ å¼€å§‹")
            if exc_type:
                print(f"[{self.name}] å¼‚å¸¸: {exc_type.__name__}")
        result = await self._actual_exit(exc_type, exc_val, exc_tb)
        if self.debug:
            print(f"[{self.name}] __aexit__ å®Œæˆ")
        return result

    async def _actual_exit(self, exc_type, exc_val, exc_tb):
        """å®é™…çš„é€€å‡ºé€»è¾‘"""
        # ... å®é™…ä»£ç 
        return False
```

### 10.6 æ€§èƒ½è€ƒè™‘

```python
class EfficientAsyncContext:
    """é«˜æ•ˆçš„å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""

    async def __aenter__(self):
        # âœ… å°½é‡å‡å°‘ä¸å¿…è¦çš„ await
        # âŒ ä¸å¥½ï¼šå¤šæ¬¡ä¸å¿…è¦çš„ç­‰å¾…
        # await asyncio.sleep(0)
        # await asyncio.sleep(0)

        # âœ… å¥½ï¼šåˆå¹¶æ“ä½œ
        # self.resource1, self.resource2 = await asyncio.gather(
        #     acquire_resource1(),
        #     acquire_resource2()
        # )
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        # âœ… å¹¶è¡Œæ¸…ç†ç‹¬ç«‹èµ„æº
        # await asyncio.gather(
        #     cleanup_resource1(),
        #     cleanup_resource2()
        # )
        return False
```

### 10.7 ä½¿ç”¨ contextlib.asynccontextmanager

å¯¹äºç®€å•çš„å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå¯ä»¥ä½¿ç”¨è£…é¥°å™¨ç®€åŒ–ï¼š

```python
from contextlib import asynccontextmanager
import asyncio

@asynccontextmanager
async def async_resource(name):
    """ç®€åŒ–çš„å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    print(f"ğŸ“‚ æ‰“å¼€ {name}")
    resource = f"èµ„æº-{name}"
    try:
        yield resource
    finally:
        print(f"ğŸ“ å…³é—­ {name}")

async def main():
    async with async_resource("MyResource") as r:
        print(f"ä½¿ç”¨: {r}")

asyncio.run(main())
```

**è¾“å‡ºï¼š**
```
ğŸ“‚ æ‰“å¼€ MyResource
ä½¿ç”¨: èµ„æº-MyResource
ğŸ“ å…³é—­ MyResource
```

---

## âœ… å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹æ£€æŸ¥é¡¹ï¼Œç¡®è®¤ä½ å·²æŒæ¡å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š

### åŸºç¡€ç†è§£
- [ ] ç†è§£ `async with` çš„è¯­æ³•
- [ ] ç†è§£ `__aenter__` å’Œ `__aexit__` çš„ä½œç”¨
- [ ] çŸ¥é“ä½•æ—¶ä½¿ç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨

### å®ç°èƒ½åŠ›
- [ ] èƒ½å¤Ÿå®ç°åŸºæœ¬çš„å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- [ ] ç†è§£æ–¹æ³•ç­¾åå’Œè¿”å›å€¼
- [ ] èƒ½å¤Ÿæ­£ç¡®å¤„ç†å¼‚å¸¸

### é«˜çº§ç‰¹æ€§
- [ ] èƒ½å¤ŸåµŒå¥—ä½¿ç”¨å¤šä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- [ ] ç†è§£å¹¶è¡Œæ‰“å¼€ï¼ˆPython 3.10+ï¼‰
- [ ] èƒ½å¤Ÿå®ç°èµ„æºæ± ç­‰å¤æ‚åœºæ™¯

### AgentScope åº”ç”¨
- [ ] ç†è§£ MsgHub çš„ä½¿ç”¨
- [ ] ç†è§£ AgentApp çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- [ ] èƒ½å¤Ÿåœ¨ AgentScope ä¸­æ­£ç¡®ä½¿ç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨

### æœ€ä½³å®è·µ
- [ ] éµå¾ªå‘½åè§„èŒƒ
- [ ] ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
- [ ] é¿å…é˜»å¡æ“ä½œ
- [ ] æ­£ç¡®å¤„ç†å¼‚å¸¸

---

## ğŸ“š å‚è€ƒèµ„æº

- [Python asyncio å®˜æ–¹æ–‡æ¡£](https://docs.python.org/3.10/library/asyncio.html)
- [PEP 492 - Async Generators](https://peps.python.org/pep-0492/)
- [contextlib - Context Utilities](https://docs.python.org/3.10/library/contextlib.html)
- [AgentScope å®˜æ–¹æ–‡æ¡£](https://doc.agentscope.io/)

---

**ç¥ä½ å­¦ä¹ é¡ºåˆ©ï¼ğŸš€**
